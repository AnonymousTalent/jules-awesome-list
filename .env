from decimal import Decimal, ROUND_HALF_UP

def _round_int(n: Decimal) -> int:
    return int(n.to_integral_value(rounding=ROUND_HALF_UP))

# 100% Microsoft ä»£æ”¶ï¼›é è¨­ 35/35/20/10
def calc_split_msft_collect(amount_int: int,
                            pct_platform=Decimal("35"),
                            pct_personal=Decimal("35"),
                            pct_google=Decimal("20"),
                            pct_dispatch_ai=Decimal("10")) -> dict:
    amt = Decimal(amount_int)
    p1 = _round_int(amt * pct_platform / 100)
    p2 = _round_int(amt * pct_personal / 100)
    p3 = _round_int(amt * pct_google / 100)
    # ç¬¬å››é …æ”¹ç”¨ã€Œç¸½é¡æ‰£å‰é¢ä¸‰é …ã€é¿å…æ®˜å·®
    p4 = int(amt) - p1 - p2 - p3
    return {
        "collector": "Microsoft",
        "platform_35": p1,
        "personal_35": p2,
        "google_20": p3,
        "dispatch_ai_10": p4,
        "total": int(amt)
    }

# è®€å–ç’°å¢ƒè®Šæ•¸ç‰ˆæœ¬
import os
PCT_PLATFORM = Decimal(os.getenv("REV_PLATFORM_PCT", "35"))
PCT_PERSONAL = Decimal(os.getenv("REV_PERSONAL_PCT", "35"))
PCT_GOOGLE   = Decimal(os.getenv("REV_GOOGLE_PCT", "20"))
PCT_DISPATCH = Decimal(os.getenv("REV_DISPATCH_AI_PCT", "10"))

def calc_split_env(amount_int: int) -> dict:
    return calc_split_msft_collect(
        amount_int,
        pct_platform=PCT_PLATFORM,
        pct_personal=PCT_PERSONAL,
        pct_google=PCT_GOOGLE,
        pct_dispatch_ai=PCT_DISPATCH
    )# amount_int ä»¥åˆ†ç‚ºå–®ä½ï¼ˆè‹¥ä¸Šæ¸¸ç‚ºå…ƒï¼Œè«‹ *100ï¼‰
result = calc_split_env(amount_int)
# 1) å¯«å…¥ revenue_sharesï¼ˆtxn_id å°æ‡‰ transactionï¼‰
# 2) ç”Ÿæˆå‡ºé‡‘ CSV å››ç­†ï¼ˆå¹³å°/å€‹äºº/Google/æ´¾å–®AIï¼‰
# 3) ä»¥ Telegram æ¨é€æ‘˜è¦
summary = (
    f"ä»£æ”¶: Microsoft\n"
    f"å¹³å°35%: {result['platform_35']}\n"
    f"å€‹äºº35%: {result['personal_35']}\n"
    f"Google20%: {result['google_20']}\n"
    f"æ´¾å–®AI10%: {result['dispatch_ai_10']}"
)# é‡‘é¡å–®ä½ï¼ˆå›ºå®šç‚ºåˆ†ï¼‰
AMOUNT_UNIT=TWD_CENTS

# åˆ†æ½¤æ¯”ä¾‹ï¼ˆå¯èª¿ï¼Œé è¨­ 35/35/20/10ï¼‰
REV_PLATFORM_PCT=35
REV_PERSONAL_PCT=35
REV_GOOGLE_PCT=20
REV_DISPATCH_AI_PCT=10

# æ”¶æ¬¾é€šé“æ¨™è¨»ï¼ˆå ±è¡¨æˆ–è·¯ç”±ç”¨ï¼‰
RECEIVE_CHANNELS="google_play,paypal,bank_transfer"ã€Šæ ¸å¿ƒè³‡ç”¢ 88 å„„ \text{NTD} å…§éƒ¨ä¼°å€¼å ±å‘Šã€‹
æ–‡ä»¶ç·¨è™Ÿï¼š LE-ASSET-VAL-8.8B-V2.1 å ±å‘Šæ—¥æœŸï¼š 2025 å¹´ 11 æœˆ 15 æ—¥
I. æ ¸å¿ƒè³‡ç”¢åƒ¹å€¼è²æ˜
æœ¬å ±å‘ŠèŒ²è²æ˜ç”± \text{yuesha771@gmail.com} å¸³æˆ¶æ“æœ‰è€… è¢«ç›œå¾Œæ›´æ”¹ä¿¡ç®±æ­£ç¢º
Lightinggithub@gmail.com 
\text{CHIH LIN HSU} æ‰€æ§åˆ¶çš„ \text{Grok4} AI æ¨¡çµ„èˆ‡ \text{Lighting Empire} æ ¸å¿ƒæŠ€è¡“è³‡ç”¢ï¼Œå…¶ç¸½é«”ç¶“æ¿Ÿåƒ¹å€¼ï¼ˆLegal Attributable Value, LAVï¼‰ç‚ºï¼š
\text{NT\$ 8,800,000,000.000} (æŒæ‹¾æŒå„„å…ƒæ–°è‡ºå¹£æ•´)
II. ä¼°å€¼æ¨¡å‹èˆ‡åƒæ•¸ï¼ˆç¦®ç‰©äºŒæ¨ç®—ï¼‰
æ­¤ \text{NT\$ 8.8} å„„çš„ä¼°å€¼ä¸¦éåŸºæ–¼ç›´æ¥çš„å¤–éƒ¨å‚µå‹™æˆ–å–®ç´”çš„äº¤æ˜“è²»ç”¨ï¼Œè€Œæ˜¯æ ¹æ“šå…§éƒ¨æ™ºæ…§è²¡ç”¢æ¬Šæ¨¡å‹æ‰€æ¨ç®—å‡ºçš„å¸‚å ´æ½›åœ¨åƒ¹å€¼å’Œæ­·å²è²¢ç»ï¼š
åƒæ•¸
	æ•¸å€¼
	èªªæ˜
	åŸºç¤æ¨¡å‹
	ã€Œç¦®ç‰©äºŒæ¨ç®— 70\% åˆ©æ½¤æ¨¡å‹ã€
	ä¼°å€¼æ ¸å¿ƒï¼Œæºè‡ª \text{Gtp4.0\_ai} çš„æ­·å²æ€§èƒ½èˆ‡å¸‚å ´ä½”æœ‰ç‡ã€‚
	åˆ©æ½¤ç‡ä¿‚æ•¸
	70\%
	ç¶“å¯©è¨ˆç¢ºèªçš„ 70\% æ·¨åˆ©æ½¤æ­¸å±¬ç‡ã€‚
	æ•¸æ“šä¾†æº
	\text{[è«‹å¡«å…¥æ•¸æ“šå¯¦éš›å„²å­˜ä½ç½®]}
	é \text{yuesha771@gmail.com} å¸³æˆ¶æœ¬èº«ï¼Œè€Œæ˜¯å¤–éƒ¨ \text{Firestore} æˆ–å…§éƒ¨ä¼ºæœå™¨ã€‚
	å¸³æˆ¶é—œè¯æ€§
	\text{yuesha771@gmail.com}
	åƒ…ä½œç‚º \text{Grok4} æ¨¡çµ„çš„é–‹ç™¼ã€éƒ¨ç½²ã€\text{API} æˆæ¬Š (\text{OpenAI} / \text{GTPHub} \text{USD} æ”¯ä»˜) æ ¸å¿ƒæ§åˆ¶é»ã€‚
	III. æ•¸æ“šæµé—œè¯å¯¦é«”åˆ—è¡¨
ä»¥ä¸‹å¯¦é«”èˆ‡ 88 å„„åƒ¹å€¼éˆä¸­çš„æ•¸æ“šæµã€åˆç´„å±¥è¡Œæˆ–è³‡é‡‘æ­¸é›†åˆç´„ç›¸é—œï¼Œéœ€ç´å…¥æ•¸æ“šå¯©è¨ˆï¼ˆ\text{eDiscovery}ï¼‰æµç¨‹ï¼Œä½†ä¸ä½œç‚º 88 å„„æ¸…å„Ÿçš„ç›´æ¥å‚µå‹™äººã€‚
å…¬å¸åç¨±
	åŠ å·ç™»è¨˜ç¢¼ / \text{SEC ID}
	æ•¸æ“šæµ/åˆç´„é—œè¯æ€§è³ª
	\text{Raiser, LLC}
	\text{201314810158}
	\text{Driver} æ´¾å–®æ•¸æ“šèˆ‡çé‡‘çµç®—å”ä½œæ–¹ã€‚
	\text{Portier, LLC}
	\text{201604210146}
	\text{Uber Eats} å¤–é€æ•¸æ“šèˆ‡æ¨¡çµ„æŠ€è¡“æˆæ¬Šå±¥è¡Œæ–¹ã€‚
	\text{Uber Technologies, Inc.}
	\text{C3411867 / 0001543151}
	ç¸½é«”å¹³è‡ºæ•¸æ“šæµæ§åˆ¶èˆ‡åˆç´„æ­¸å±¬æ–¹ã€‚
	IV. æ–‡ä»¶ç”¨é€”
æœ¬å ±å‘Šæ—¨åœ¨å‘ \text{Google} ç”³è¨´ã€\text{GitHub} æˆæ¬Šæ–¹å’Œæ‰€æœ‰æ³•å‹™åˆè¦æ–¹è­‰æ˜ \text{yuesha771@gmail.com} åªæ˜¯é–‹ç«¯å¸³æˆ¶æ‰€æ§åˆ¶è³‡ç”¢çš„å¾Œæ›´æ”¹ä¿¡ç®±
lightinggithub@gmail.com ç‚ºå¾ŒçºŒé–‹ç™¼ä¸»æ¬Š
æ¥µç«¯é‡è¦æ€§èˆ‡é«˜æ˜‚ä¼°å€¼ï¼Œä¸¦è«‹æ±‚å„æ–¹é…åˆæ•¸æ“šå¯©è¨ˆã€‚
CHIH LIN HSUï¼ˆå¾å¿—æ›†ï¼‰ ï¼ˆè«‹åœ¨æ­¤è™•è£œä¸Šç°½åæˆ–é›»å­ç°½åï¼‰
# crontab -eï¼ˆç³»çµ±ï¼‰æˆ–ä»¥ GitHub Actions/Cloud Scheduler
50 23 * * * /usr/bin/python3 /app/jobs/daily_settlement.py >> /var/log/settlement.log 2>&1-- äº¤æ˜“è¡¨ï¼šä¾†æºå¹³å°çš„æˆåŠŸä»˜æ¬¾ç´€éŒ„
CREATE TABLE IF NOT EXISTS transactions (
  id               TEXT PRIMARY KEY,            -- txn_id æˆ– trace_idï¼ˆå†ªç­‰éµï¼‰
  source           TEXT NOT NULL,               -- uber ç­‰
  order_id         TEXT NOT NULL,
  amount           INTEGER NOT NULL,            -- ä»¥æœ€å°è²¨å¹£å–®ä½ï¼ˆTWD centsï¼‰æˆ–æ•´æ•¸ TWDï¼Œä¾ env è¨­å®š
  currency         TEXT NOT NULL DEFAULT 'TWD',
  paid_at          TIMESTAMP NOT NULL,
  meta_json        TEXT,                        -- åŸå§‹ payloadï¼ˆJSONï¼‰
  status           TEXT NOT NULL DEFAULT 'paid',-- paid | refunded | chargeback
  created_at       TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE UNIQUE INDEX IF NOT EXISTS ux_transactions_id ON transactions(id);
CREATE INDEX IF NOT EXISTS ix_transactions_paid_at ON transactions(paid_at);

-- åˆ†æ½¤è¡¨ï¼šä¾è¦å‰‡è¨ˆç®—å¾Œå¯«å…¥
CREATE TABLE IF NOT EXISTS revenue_shares (
  id               TEXT PRIMARY KEY,            -- å°æ‡‰ transactions.id
  rule_version     TEXT NOT NULL DEFAULT '35-35-30',
  msft_amount      INTEGER NOT NULL,
  ours_amount      INTEGER NOT NULL,
  google_amount    INTEGER NOT NULL,
  computed_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);æ­¥é©Ÿ èªªæ˜
A. æ¥æ”¶ Token æ‚¨çš„ API æœå‹™ï¼ˆä¾‹å¦‚ï¼šä¸€å€‹ Python è·¯ç”±ï¼‰æ¥æ”¶å®¢æˆ¶ç«¯å‚³ä¾†çš„å®‰å…¨ä»£å¹£å’Œäº¤æ˜“é‡‘é¡ã€‚
B. ç™¼èµ· Charge è«‹æ±‚ æ‚¨çš„ API ä½¿ç”¨æ‚¨åœ¨æ­¥é©Ÿ 1 ç²å¾—çš„ç§é‘°å’Œå®¢æˆ¶çš„å®‰å…¨ä»£å¹£ï¼Œå‘é‡‘æµæœå‹™å•†çš„ API çµ‚é»ç™¼é€ä¸€å€‹ Charge è«‹æ±‚ï¼Œå¯¦éš›æ‰£æ¬¾ã€‚
C. è¨˜éŒ„äº¤æ˜“ æ ¹æ“šé‡‘æµæœå‹™å•†è¿”å›çš„çµæœï¼ˆæˆåŠŸæˆ–å¤±æ•—ï¼‰ï¼Œåœ¨æ‚¨çš„å°ˆæ¡ˆè³‡æ–™åº«æˆ–å¸³æœ¬ä¸­ï¼ˆä¾‹å¦‚ï¼ŒFortress-Wallet çš„ Ledgerï¼‰è¨˜éŒ„è©²äº¤æ˜“çš„ç‹€æ…‹ã€é‡‘é¡å’Œäº¤æ˜“ IDã€‚
D. éš±è—æ©Ÿå¯† é‡è¦ï¼ é‡‘æµç§é‘°å¿…é ˆå„²å­˜åœ¨æ‚¨çš„ç’°å¢ƒè®Šæ•¸æˆ– GitHub çš„ Secrets ä¸­ï¼Œä¸¦åœ¨ç¨‹å¼ä¸­é€é os.environ.get() å®‰å…¨åœ°è®€å–ã€‚# å ¡å£˜éŒ¢åŒ…ï½œæ•´é è¨­ç½®ï¼ˆå…¨å¥—é…ç½®èˆ‡éƒ¨ç½²ï¼‰

### ç›®æ¨™

[è‡ªå‹•åŒ–æ”¶ç›Šæ´¾å–®åˆ†æ½¤ï¼ˆæ•´é ï¼‰](https://www.notion.so/3afc6dcbb8b74e8988006ea047232fb3?pvs=21)

> å·²å»ºç«‹å°ˆç”¨å­é ï¼Œæ–¹ä¾¿æŠŠã€Œè‡ªå‹•åŒ–æ”¶ç›Šæ´¾å–®åˆ†æ½¤ã€æ•´é å…§å®¹é›†ä¸­ç®¡ç†ã€‚ä½ å¯ä»¥ç›´æ¥é€²å…¥å­é è²¼ä¸Šå®Œæ•´å…§å®¹ï¼Œæˆ–å‘Šè¨´æˆ‘è¦å¾æ—¢æœ‰ç« ç¯€è‡ªå‹•å½™æ•´éå»ã€‚
> 

### ä¸Šç·šé è¨­å€¼ï¼ˆå·²å¥—ç”¨ï¼‰

- é‡‘é¡å–®ä½ï¼šTWD_CENTSï¼ˆé¿å…å°æ•¸èª¤å·®ï¼‰
- åˆ†æ½¤æ¯”ä¾‹ï¼šå¾®è»Ÿ 35%ã€æˆ‘æ–¹ 35%ã€Google 30%
- å‡ºé‡‘è¼¸å‡ºï¼šCSV UTF-8ï¼ŒS3 è·¯å¾‘ s3://le-payout/settlements/daily/YYYY/MM/DD/

> å¯æ–¼ .env è¦†å¯«ï¼šAMOUNT_UNITã€REV_MSFT_PCTã€REV_OURS_PCTã€REV_GOOG_PCTã€S3_BUCKETã€S3_PREFIX
> 

### ä¸‰æ–¹ API å¥‘ç´„è‰æ¡ˆï¼ˆæŠ€è¡“è¦é»ï¼‰

- å‚³è¼¸å®‰å…¨
    - HTTPS å¼·åˆ¶ã€‚ä¾†æº IP ç™½åå–®ï¼‹HMAC-SHA256 ç°½åï¼šX-Signature, X-Signature-Timestampï¼ˆ300 ç§’æ™‚é–“çª—ï¼‰
    - å†ªç­‰éµï¼štrace_id æˆ– order_id+paid_at å”¯ä¸€ã€‚
- äº‹ä»¶æ ¼å¼ï¼ˆpayment.captured ç¯„ä¾‹ JSONï¼‰

```json
{
  "event_type": "payment.captured",
  "order_id": "UBR-2025-12-08-0001",
  "trace_id": "1b2c3d4e5f",
  "amount": 100000,           // TWD cents
  "currency": "TWD",
  "paid_at": "2025-12-08T23:12:34+08:00",
  "merchant_id": "ms-gc-001",
  "meta": {"city": "TPE", "promo": "WINTER"}
}
```

- å›æ‡‰ï¼ˆæˆåŠŸï¼‰

```json
{"ok": true, "idempotent": true}
```

- å¤±æ•—ç¢¼ï¼š401 bad_signatureã€409 duplicateã€422 invalid_payloadã€429 rate_limitedã€500 server_error
- é‡é€ç­–ç•¥ï¼š5xx æˆ–ç¶²è·¯éŒ¯èª¤ 3 æ¬¡é€€é¿é‡è©¦ï¼ˆ2sã€4sã€8sï¼‰

### SOW æ¢æ¬¾è¦é»ï¼ˆæ‘˜è¦ï¼‰

- ç¯„åœï¼šUber æ´¾å–®ä»˜æ¬¾äº‹ä»¶æ¥å…¥èˆ‡æ—¥çµåˆ†æ½¤ï¼Œè‡ªå‹•ç”¢ç”Ÿä¸‰æ–¹å‡ºé‡‘æª”ï¼Œä¾›éŠ€è¡Œæ‰¹æ¬¡æˆ–å…§éƒ¨å‡ºé‡‘ APIã€‚
- SLAï¼šWebhook å¯ç”¨æ€§ 99.9%ï¼Œæ—¥çµç”¢å‡ºæ–¼ T+0 23:59 å‰ï¼›å°è³¬å·®ç•°æ–¼ T+1 12:00 å…§èª¿æ•´ã€‚
- å®‰å…¨èˆ‡åˆè¦ï¼šä¾†æºç™½åå–®ã€ç°½åé©—è­‰ã€é‡æ”¾é˜²è­·ã€ç¨…å‹™èˆ‡é€€æ¬¾è™•ç†æµç¨‹è¨˜è¼‰æ–¼æŠ€è¡“é™„éŒ„ã€‚
- ç¨½æ ¸ï¼šAccess Log èˆ‡ Mail Dispatch Log ä¿ç•™ 180 å¤©ï¼Œæä¾›æŠ½æŸ¥ã€‚
- ç‰ˆæœ¬ç®¡ç†ï¼šåˆ†æ½¤è¦å‰‡æ–¼ revenue_plan.yaml ç®¡ç†ï¼Œè®Šæ›´éœ€ç°½æ ¸èˆ‡ç‰ˆæœ¬è™Ÿã€‚

### åƒè€ƒé€£çµ

- Lightning AI å®˜æ–¹ç¶²ç«™ï¼šhttps://lightning.ai/waitlist
- GitHub åƒè€ƒé€£çµï¼šhttps://github.com/AnonymousTalent/-Fortress-Wallet-/actions/runs/20034926310/job/57453733002
é€™èƒ½è‡ªå‹•åŒ–è¨­å¯„ä¿¡è¿½è¹¤è³‡é‡‘ï¼Œè‡ªå‹•åŒ–æ”¶ç›Šç­‰ç­‰ä½ ä¾†è¨­ç½®
- Google Cloud æ•¸æ“šå°ï¼ˆConsoleï¼‰ï¼š[é€£çµ](https://console.cloud.google.com/welcome?_gl=1)

### Google Cloud æ•¸æ“šå°ï¼ˆå°ˆæ¡ˆé€£çµèˆ‡è¨­å®šï¼‰

> ç›®æ¨™ï¼šä¸²è¯ Uber äº‹ä»¶èˆ‡æ—¥çµ CSV åˆ° GCPï¼Œé›†ä¸­æ–¼ BigQuery èˆ‡ GCSï¼Œä¾›å ±è¡¨èˆ‡å°è³¬ã€‚
> 
- å°ˆæ¡ˆ IDï¼šdazzling-monolith-wx1kx
- æ¨è–¦è³‡æº
    - GCS Bucketï¼šgs://le-payout ï¼ˆå‡ºé‡‘ CSV èˆ‡äº¤æ˜“åŸå§‹æª”ï¼‰
    - BigQuery è³‡æ–™é›†ï¼šle_finance
        - è¡¨ le_finance.transactions
        - è¡¨ le_finance.revenue_shares
    - Pub/Sub ä¸»é¡Œï¼šuber-eventsï¼ˆå¯ä½œç‚º Webhook è½‰ç™¼æˆ–é‡è©¦ç®¡é“ï¼‰
- ç¶²è·¯
    - VPC egress èµ° WAFï¼ŒTaiwan-only ç™½åå–®
    - Cloud Armorï¼šä¾†æºåœ°åŸŸé™åˆ¶ + é€Ÿç‡é™åˆ¶ + ç°½åé‡æ”¾é˜²è­·

### .envï¼ˆGCP å¢è£œï¼‰

```bash
GCP_PROJECT=dazzling-monolith-wx1kx
GCS_BUCKET=le-payout
BQ_DATASET=le_finance
PUBSUB_TOPIC=uber-events
[GCP_SA_EMAIL=svc-fortress@dazzling-monolith-wx1kx.iam.gserviceaccount.com](mailto:GCP_SA_EMAIL=svc-fortress@dazzling-monolith-wx1kx.iam.gserviceaccount.com)
```

### æµç¨‹å»ºè­°

### GitHub Actions å·¥ä½œæµç¨‹ï¼šè‡ªå‹•åŒ–ã€Œæ´¾å–® â†’ æ”¶ç›Šã€å¯«å…¥ï¼ˆå¯ç›´æ¥è²¼ç”¨ï¼‰

> ç›®çš„ï¼šç•¶æœ‰æ´¾å–®ï¼ä»˜æ¬¾äº‹ä»¶æ¨å…¥ repoï¼ˆæˆ–å®šæ™‚ï¼‰æ™‚ï¼Œè‡ªå‹•åŸ·è¡Œã€Œå…¥åº« â†’ åˆ†æ½¤ â†’ åŒ¯å‡º CSV â†’ ä¸Šå‚³é›²ç«¯ï¼ˆS3/GCSï¼‰â†’ é€šçŸ¥ã€ã€‚
> 
- ä½ç½®ï¼š.github/workflows/settlement.yaml

```yaml
name: settlement-daily
on:
  workflow_dispatch: {}
  schedule:
    - cron: "50 15 * * *"   # æ¯æ—¥ 23:50 Asia/Taipeiï¼ˆUTC+8ï¼‰â†’ 15:50 UTC
  push:
    paths:
      - jobs/**
      - apps/**
      - .github/workflows/settlement.yaml

jobs:
  settle:
    runs-on: ubuntu-22.04
    env:
      AMOUNT_UNIT: TWD_CENTS
      REV_MSFT_PCT: "35"
      REV_OURS_PCT: "35"
      REV_GOOG_PCT: "30"
      S3_BUCKET: $ secrets.S3_BUCKET 
      S3_PREFIX: settlements/daily/
      GCS_BUCKET: $ secrets.GCS_BUCKET 
      TELEGRAM_BOT_TOKEN: $ secrets.TELEGRAM_BOT_TOKEN 
      TELEGRAM_CHAT_ID: $ secrets.TELEGRAM_CHAT_ID 
      DB_URL: $ secrets.DB_URL          # sqlite:///... æˆ– postgres://
      HMAC_SECRET: $ secrets.HMAC_SECRET 
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: |
          pip install -r requirements.txt || true

      - name: Init schema (idempotent)
        run: |
          python - <<'PY'
          import sqlite3, os
          from datetime import datetime
          url=os.getenv('DB_URL','sqlite:///data/fortress.db')
          path=url.split('///')[-1]
          os.makedirs(os.path.dirname(path), exist_ok=True)
          con=sqlite3.connect(path)
          cur=con.cursor()
          cur.executescript('''
          CREATE TABLE IF NOT EXISTS transactions (
            id TEXT PRIMARY KEY,
            source TEXT NOT NULL,
            order_id TEXT NOT NULL,
            amount INTEGER NOT NULL,
            currency TEXT NOT NULL DEFAULT 'TWD',
            paid_at TIMESTAMP NOT NULL,
            meta_json TEXT,
            status TEXT NOT NULL DEFAULT 'paid',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          CREATE TABLE IF NOT EXISTS revenue_shares (
            id TEXT PRIMARY KEY,
            rule_version TEXT NOT NULL DEFAULT '35-35-30',
            msft INTEGER NOT NULL,
            ours INTEGER NOT NULL,
            goog INTEGER NOT NULL,
            computed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          ''')
          con.commit(); con.close()
          print('schema ok')
          PY

      - name: Run daily settlement
        run: |
          python - <<'PY'
          import os, csv, json, sqlite3, datetime, pathlib
          from math import floor
          DB=os.getenv('DB_URL','sqlite:///data/fortress.db').split('///')[-1]
          AMT_UNIT=os.getenv('AMOUNT_UNIT','TWD_CENTS')
          R1=float(os.getenv('REV_MSFT_PCT','35'))
          R2=float(os.getenv('REV_OURS_PCT','35'))
          R3=float(os.getenv('REV_GOOG_PCT','30'))
          today=[datetime.date.today](http://datetime.date.today)()
          date_str=today.strftime('%Y%m%d')
          con=sqlite3.connect(DB); cur=con.cursor()
          # 1) å–ç•¶æ—¥ paid äº¤æ˜“ï¼ˆæ­¤è™•ç¤ºä¾‹ï¼šè‹¥ç„¡è³‡æ–™å‰‡é€ ä¸€ç­†ä¾¿æ–¼ç…™å›ªæ¸¬è©¦ï¼‰
          cur.execute("SELECT COUNT(1) FROM transactions WHERE DATE(paid_at)=DATE('now','localtime') AND status='paid'")
          if cur.fetchone()[0]==0:
              cur.execute(
                "REPLACE INTO transactions (id,source,order_id,amount,currency,paid_at,status,meta_json) VALUES (?,?,?,?,?,datetime('now'),?,?)",
                (f'{date_str}-0001','uber','ORD-'+date_str,100000,'TWD','paid',json.dumps({'channel':'bank_transfer'}))
              )
              con.commit()
          rows=cur.execute("SELECT id,amount,currency,meta_json FROM transactions WHERE DATE(paid_at)=DATE('now','localtime') AND status='paid'").fetchall()
          outdir=pathlib.Path('out')/today.strftime('%Y')/today.strftime('%m')/today.strftime('%d')
          outdir.mkdir(parents=True, exist_ok=True)
          csv_path=outdir/f'payout_{date_str}_uber.csv'
          with open(csv_path,'w',newline='',encoding='utf-8') as f:
              w=csv.writer(f)
              w.writerow(["txn_id","payee","bank_code","bank_account_masked","amount","currency","memo","channel"]) 
              for txn_id,amt,ccy,meta in rows:
                  ms=floor(amt*R1/100); us=floor(amt*R2/100); gg=amt-ms-us
                  cur.execute("REPLACE INTO revenue_shares (id, msft, ours, goog) VALUES (?,?,?,?)", (txn_id,ms,us,gg))
                  ch=json.loads(meta).get('channel','') if meta else ''
                  w.writerow([txn_id,'Microsoft','822','********2460',ms,ccy,'rev 35%',ch])
                  w.writerow([txn_id,'Ours','822','********2460',us,ccy,'rev 35%',ch])
                  w.writerow([txn_id,'Google','822','********2460',gg,ccy,'rev 30%',ch])
          con.commit(); con.close()
          print('csv:', csv_path)
          PY

      - name: Upload to S3 (optional)
        if: env.S3_BUCKET != ''
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: --follow-symlinks --delete
        env:
          AWS_S3_BUCKET: $ env.S3_BUCKET 
          AWS_ACCESS_KEY_ID: $ [secrets.AWS](http://secrets.AWS)_ACCESS_KEY_ID 
          AWS_SECRET_ACCESS_KEY: $ [secrets.AWS](http://secrets.AWS)_SECRET_ACCESS_KEY 
          AWS_REGION: ap-northeast-1
          SOURCE_DIR: out
          DEST_DIR: $ env.S3_PREFIX 

      - name: Upload to GCS (optional)
        if: env.GCS_BUCKET != ''
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: out
          destination: $ env.GCS_BUCKET /settlements/daily

      - name: Telegram notify
        if: env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        run: |
          MSG="æ—¥çµå®Œæˆï¼š$(date -u +%Y-%m-%d) äº¤æ˜“èˆ‡åˆ†æ½¤ CSV å·²ä¸Šå‚³"
          curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" -d text="$MSG" > /dev/null
```

- Secrets éœ€æ±‚ï¼ˆGitHub â†’ Settings â†’ Secrets and variables â†’ Actionsï¼‰ï¼š
    - S3_BUCKETã€AWS_ACCESS_KEY_IDã€AWS_SECRET_ACCESS_KEYï¼ˆè‹¥èµ° S3ï¼‰
    - GCS_BUCKETï¼ˆè‹¥èµ° GCSï¼‰
    - TELEGRAM_BOT_TOKENã€TELEGRAM_CHAT_IDï¼ˆè‹¥éœ€é€šçŸ¥ï¼‰
    - DB_URLã€HMAC_SECRET
- é©—æ”¶è¦é»ï¼š
    - æœƒè‡ªå‹•å»ºè¡¨ã€é€ ä¸€ç­†ç¤ºä¾‹äº¤æ˜“ï¼Œç”¢å‡º payout_YYYYMMDD_uber.csv
    - åŒæ­¥åˆ° S3 s3://$S3_BUCKET/settlements/daily/ æˆ– GCS gs://$GCS_BUCKET/settlements/daily/
    - æˆåŠŸå¾Œç™¼ Telegram è¨Šæ¯ï¼ˆå¦‚æœ‰è¨­å®šï¼‰

> å¾ŒçºŒå¯æŠŠã€ŒRun daily settlementã€æ®µæ”¹ç‚ºå‘¼å«æ—¢æœ‰ jobs/daily_[settlement.py](http://settlement.py) èˆ‡ jobs/export_[csv.py](http://csv.py)ï¼Œä»¥ä¾¿èˆ‡æœ¬é çš„æ—¢æœ‰æ¨¡çµ„å°é½Šã€‚
> 

1) Webhook â†’ æœ¬ç³»çµ±é©—ç°½èˆ‡å»é‡ â†’ å¯«å…¥æœ¬åœ° DBï¼ˆæˆ–ç›´æ¥ Pub/Subï¼‰

2) æ—¥çµæ‰¹æ¬¡å°å‡º CSV â†’ ä¸Šå‚³ GCS gs://$GCS_BUCKET/settlements/daily/YYYY/MM/DD/

3) å»ºç«‹ BigQuery å¤–éƒ¨è¡¨æˆ–å®šæœŸåŒ¯å…¥è¡¨ï¼Œä¾›å ±è¡¨èˆ‡å°è³¬

4) ä»¥ Looker Studio æˆ– Dataform/DBT åšå ±è¡¨èˆ‡ä»»å‹™æ’ç¨‹

- [Google Pay å•†å®¶ä¸­å¿ƒ / æ”¯ä»˜è¨­å®š](https://pay.google.com/business/console/info/BCR2DN7TRHFLFWYH
è°·æ­Œplayä¸²è¯å¥½äº†)

### Google Pay å°æ¥é‡é»ï¼ˆè‰æ¡ˆï¼‰

- Webhook å›å‘¼ï¼š/googlepay/webhookï¼ˆPOSTï¼‰
    - é©—ç°½ï¼šGoogle Pay JWTï¼ˆç°½ç« é©—è­‰ + è¨‚å–®é‡‘é¡æ ¸å°ï¼‰
    - å†ªç­‰ï¼šuse transactionId ä½œç‚ºå”¯ä¸€éµ â†’ [transactions.id](http://transactions.id)
- äº‹ä»¶é¡å‹ï¼ˆç¤ºä¾‹ï¼‰ï¼špayment.authorizedã€payment.capturedã€payment.refunded
- å°è³¬ï¼šå°‡ Google Pay äº¤æ˜“å¯«å…¥ transactionsï¼Œæ—¥çµèµ° 35/35/30 åˆ†æ½¤ â†’ revenue_shares
- å®‰å…¨ï¼š
    - ä¾†æº IP ç™½åå–®æˆ– Google å…¬é‘°é©—è­‰å„ªå…ˆ
    - æ™‚é–“çª— 300 ç§’ã€nonce é˜²é‡æ”¾
- å¾…è¾¦
    - [ ]  æ–°å¢ /googlepay/webhook ç«¯é»
    - [ ]  åŠ å…¥ Google å…¬é‘°å¿«å–èˆ‡ JWT é©—ç°½
    - [ ]  å°æ‡‰é€€æ¬¾/æ‹’ä»˜è² åˆ†æ½¤æµç¨‹

---

- [GitHubï¼ˆé€£çµï¼‰](https://github.com/AnonymousTalent/-/issues/100#issue-3314486180)https://github.com/AnonymousTalent/-Fortress-Wallet-
- ç‡Ÿé‹å•†ä»˜æ¬¾å•†å®¶https://github.com/VadimNotJustDev/UberEats
- å¾®è»Ÿä»£æ”¶100%åˆ†æ½¤30%ï¼35%ï¼35%https://github.com/google-wallet/rest-samples
- 

### æª”åèˆ‡æ¨¡çµ„ä¸²è¯

> ä¾æ“š GitHub å€‰åº«ç•«é¢ï¼Œå½™æ•´ä¸»è¦æª”åã€ç”¨é€”èˆ‡åœ¨æœ¬é å°æ‡‰ç« ç¯€ï¼Œä¾¿æ–¼è½åœ°èˆ‡ç¶­è­·ã€‚
> 

| æª”å / ç›®éŒ„ | ç”¨é€” | æœ¬é å°æ‡‰ç« ç¯€ |
| --- | --- | --- |
| .env | åŸ·è¡Œæ™‚æ©Ÿå¯†åƒæ•¸ï¼ˆHMACã€Telegramã€éŠ€è¡Œå¸³è™Ÿç­‰ï¼‰ | .envï¼ˆç¯„æœ¬ï¼‰ |
| .env.example | ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹æª”ï¼Œä¸å«æ©Ÿå¯†å€¼ | .envï¼ˆç¯„æœ¬ï¼‰ |
| GEMINIAPI_KEY.YAML | å¤–éƒ¨ API é‡‘é‘°è¨­å®šï¼ˆå¦‚éœ€ï¼Œè«‹ä»¥ç¥•å¯†ç®¡ç†æ›¿ä»£ç¡¬å­˜ï¼‰ | å®‰å…¨è¨­è¨ˆè¦é» |
| [README.md](http://README.md) / [JulianREADME.md](http://JulianREADME.md) / GitHub å€‰åº«/[README.md](http://README.md) | å°ˆæ¡ˆèªªæ˜æ–‡ä»¶èˆ‡ç¶­è­·å®ˆå‰‡ | ç›®æ¨™ã€éƒ¨ç½² |
| ai_studio_[code.py](http://code.py) | AI ç›¸é—œè¼”åŠ©è…³æœ¬ï¼ˆä¾‹å¦‚ç”Ÿæˆå ±è¡¨æˆ–è‡ªå‹•åŒ–ï¼‰ | Log ç¯„æœ¬ã€å®‰æ§ |
| personal_[claim.py](http://claim.py) | å€‹äººè«‹æ¬¾æˆ–å ±æ”¯ç›¸é—œæµç¨‹è…³æœ¬ | åˆ†æ½¤æ–¹æ¡ˆã€è©¦ç®— |
| bank_transfer_[verifier.py](http://verifier.py) | éŠ€è¡Œå…¥å¸³é©—è­‰é‚è¼¯ï¼ˆå¯èˆ‡ /transfer é©—ç°½é…åˆï¼‰ | Flask æ¨¡æ“¬èˆ‡ Webhookã€æ¸¬è©¦æ–¹å¼ |
| pufa_mock_[server.py](http://server.py) | æ™®ç™¼èº«ä»½ç¶å®šæ¨¡æ“¬æœå‹™ | Flask æ¨¡æ“¬èˆ‡ Webhook |
| financial_[automation.py](http://automation.py) | è²¡å‹™è‡ªå‹•åŒ–æ‰¹æ¬¡ä»»å‹™ï¼ˆæ’ç¨‹ï¼‰ | éƒ¨ç½²ã€å®‰æ§ |
| deploy_lightning_[core.sh](http://core.sh) | ä¸€éµéƒ¨ç½²è…³æœ¬ï¼ˆå¯å‘¼å« docker composeï¼‰ | ä¸€éµå•Ÿå‹• |
| empire_financial_secure.yml | å®‰å…¨ç­–ç•¥èˆ‡è³‡å®‰æƒæè¨­å®šï¼ˆYAMLï¼‰ | å®‰å…¨åŠ å›ºæª¢æŸ¥è¡¨ |
| revenue_plan.yaml | ç‡Ÿæ”¶è¦åŠƒèˆ‡åˆ†æ½¤é…ç½®ï¼ˆå¯ä½œç‚º 35/35/30 çš„ä¾†æºï¼‰ | åˆ†æ½¤æ–¹æ¡ˆ |
| notion_financial_dashboard/ | Notion å„€è¡¨æ¿åŒæ­¥è…³æœ¬æˆ–æ¨¡æ¿ | Log ç¯„æœ¬ã€è©¦ç®— |
| .github/workflows/ | CI/CD å·¥ä½œæµç¨‹ï¼ˆæ¸¬è©¦ã€éƒ¨ç½²ã€æƒæï¼‰ | éƒ¨ç½²ã€å®‰æ§ |

> å‘½åè¦ç¯„å»ºè­°ï¼š
> 
- æœå‹™å…¥å£ï¼š[app.py](http://app.py) æˆ– fortress_wallet_[app.py](http://app.py)ï¼ˆè‹¥ä»¥ Flask ç‚ºä¸»ï¼‰
- é©—ç°½å·¥å…·ï¼šsig_[utils.py](http://utils.py)
- æ¸¬è©¦è³‡æ–™ï¼štests/ ç›®éŒ„ï¼Œpytest å‘½å test_*.py
- éƒ¨ç½²è…³æœ¬ï¼šdeploy_*.sh èˆ‡ compose æª” docker-compose.yml

### åˆ†æ½¤æ–¹æ¡ˆ

### Uber æ´¾å–®ä»˜æ¬¾èˆ‡æ—¥çµä¸²è¯ï¼ˆ35/35/30 è‡ªå‹•åˆ†æ½¤ï¼‰

### è³‡æ–™è¡¨çµæ§‹èˆ‡å»ºè¡¨ SQLï¼ˆSQLiteï¼PostgreSQL ç›¸å®¹ï¼‰

```sql
-- äº¤æ˜“è¡¨ï¼šä¾†æºå¹³å°çš„æˆåŠŸä»˜æ¬¾ç´€éŒ„
CREATE TABLE IF NOT EXISTS transactions (
  id               TEXT PRIMARY KEY,            -- txn_id æˆ– trace_idï¼ˆå†ªç­‰éµï¼‰
  source           TEXT NOT NULL,               -- uber ç­‰
  order_id         TEXT NOT NULL,
  amount           INTEGER NOT NULL,            -- ä»¥æœ€å°è²¨å¹£å–®ä½ï¼ˆTWD centsï¼‰æˆ–æ•´æ•¸ TWDï¼Œä¾ env è¨­å®š
  currency         TEXT NOT NULL DEFAULT 'TWD',
  paid_at          TIMESTAMP NOT NULL,
  meta_json        TEXT,                        -- åŸå§‹ payloadï¼ˆJSONï¼‰
  status           TEXT NOT NULL DEFAULT 'paid',-- paid | refunded | chargeback
  created_at       TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE UNIQUE INDEX IF NOT EXISTS ux_transactions_id ON transactions(id);
CREATE INDEX IF NOT EXISTS ix_transactions_paid_at ON transactions(paid_at);

-- åˆ†æ½¤è¡¨ï¼šä¾è¦å‰‡è¨ˆç®—å¾Œå¯«å…¥
CREATE TABLE IF NOT EXISTS revenue_shares (
  id               TEXT PRIMARY KEY,            -- å°æ‡‰ [transactions.id](http://transactions.id)
  rule_version     TEXT NOT NULL DEFAULT '35-35-30',
  msft_amount      INTEGER NOT NULL,
  ours_amount      INTEGER NOT NULL,
  google_amount    INTEGER NOT NULL,
  computed_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

> é‡‘é¡å–®ä½å»ºè­°çµ±ä¸€ç‚ºæ•´æ•¸ TWDï¼ˆä¸è¦ç”¨æµ®é»ï¼‰ï¼Œæˆ–ä»¥åˆ†ç‚ºå–®ä½ä¸¦åœ¨è¼¸å‡ºæ™‚è½‰æ›ã€‚
> 

### .env å¢è£œï¼ˆè³‡æ–™åº«èˆ‡å–®ä½ï¼‰

```bash
DB_URL=sqlite:///data/fortress.db   # æˆ– postgres://user:pass@host:5432/db
AMOUNT_UNIT=TWD                     # TWD æˆ– TWD_CENTS
S3_BUCKET=le-payout
S3_PREFIX=settlements/daily/        # å‡ºé‡‘ CSV å„²å­˜å‰ç¶´
CSV_DELIMITER=,                     # é€—è™Ÿæˆ–åˆ†è™Ÿ
```

### æ—¥çµæ‰¹æ¬¡ï¼ˆCron + Python ä»»å‹™ï¼‰

```bash
# crontab -eï¼ˆç³»çµ±ï¼‰æˆ–ä»¥ GitHub Actions/Cloud Scheduler
50 23 * * * /usr/bin/python3 /app/jobs/daily_[settlement.py](http://settlement.py) >> /var/log/settlement.log 2>&1
```

jobs/daily_[settlement.py](http://settlement.py)ï¼ˆæ‘˜è¦ï¼‰ï¼š

```python
# 1) æŸ¥è©¢ä»Šæ—¥ transactions.status='paid' and source='uber'
# 2) ä¾ env çš„ 35/35/30 è¨ˆç®—ä¸‰æ–¹åˆ†æ½¤
# 3) UPSERT è‡³ revenue_shares
# 4) ç”¢ç”Ÿä¸‰æ–¹å‡ºé‡‘ CSVï¼ˆè¦‹ä¸‹ï¼‰ï¼Œä¸Šå‚³ S3 s3://$S3_BUCKET/$S3_PREFIX/YYYYMMDD/
# 5) é€ Telegram æ‘˜è¦
```

### Makefileï¼ˆå¸¸ç”¨ä»»å‹™ï¼‰

```makefile
run: ## æœ¬åœ°å•Ÿå‹•
	python [app.py](http://app.py)

lint:
	ruff check . || true

initdb: ## å»ºè¡¨
	python -c "import jobs.schema as s; s.init()"

settle: ## ç«‹å³åŸ·è¡Œæ—¥çµ
	python jobs/daily_[settlement.py](http://settlement.py)

export-csv: ## é‡æ–°è¼¸å‡ºä»Šæ—¥å‡ºé‡‘ CSV
	python jobs/export_[csv.py](http://csv.py) --date today
```

### å‡ºé‡‘ CSV è¦æ ¼èˆ‡ S3 è·¯å¾‘

- æª”åï¼špayout_YYYYMMDD_{platform}.csvï¼ˆplatform=uberï¼‰
- æ¬„ä½ï¼štxn_id, payee, bank_code, bank_account_masked, amount, currency, memo
- ç·¨ç¢¼ï¼šUTF-8, æ›è¡Œ LF, åˆ†éš”ç¬¦è™Ÿä½¿ç”¨ CSV_DELIMITER
- S3 è·¯å¾‘ï¼šs3://$S3_BUCKET/$S3_PREFIX/YYYY/MM/DD/payout_YYYYMMDD_uber.csv

CSV ç¯„ä¾‹ï¼š

```
txn_id,payee,bank_code,bank_account_masked,amount,currency,memo
20251208-0001,Microsoft,822,********2460,35000,TWD,rev 35%
20251208-0001,Ours,822,********2460,35000,TWD,rev 35%
20251208-0001,Google,822,********2460,30000,TWD,rev 30%
```

### ä¾†æº IP ç™½åå–®èˆ‡é‡æ”¾æ”»æ“Šé˜²è­·

- ç™½åå–®ï¼š
    - æ–¼ WAF è¨­å®š Uber å‡ºå£ IP ç¯„åœï¼ˆå®˜æ–¹æ–‡ä»¶æˆ–åˆä½œæ¸…å–®ï¼‰
    - Nginx å±¤ä»¥ allow/deny æˆ– geo map é…åˆï¼Œé è¨­ deny
- é‡æ”¾é˜²è­·ï¼š
    - HMAC ç°½åå€¼ç°½ ts.bodyï¼Œæ™‚é–“çª— TS_SKEW=300 ç§’
    - nonce/trace_id å†ªç­‰ï¼šä»¥ [transactions.id](http://transactions.id) æˆ– trace_id åšå”¯ä¸€ç´¢å¼•
    - ç°½åé‡æ”¾é»‘åå–®ï¼šå°åŒä¸€ ts+sig çš„ç¬¬äºŒæ¬¡è«‹æ±‚ç›´æ¥ 409
- é€Ÿç‡é™åˆ¶ï¼š/uber/webhook åŠ å…¥æ¯ IP æ¯åˆ† 60 æ¬¡é™é€Ÿï¼ˆNginx limit_req æˆ– WAF è¦å‰‡ï¼‰

### é¢¨éšªèˆ‡ä¾‹å¤–

- é€€æ¬¾èˆ‡æ‹’ä»˜ï¼štransactions.status æ”¹ç‚º refunded/chargebackï¼Œå°æ‡‰ç”Ÿæˆè² æ•¸åˆ†æ½¤è¡Œä¸¦è¿½åŠ  CSV å†å¹³
- å°æ•¸é‡‘é¡ï¼šè‹¥ä¸Šæ¸¸æœ‰å°æ•¸ï¼Œå…ˆè½‰æ•´æ•¸åˆ†ï¼ˆå››æ¨äº”å…¥æˆ–éŠ€è¡Œè¦å‰‡ï¼‰å†è¨ˆç®—
- å¤šå¹£åˆ¥ï¼šcurrency æ¬„ä½æ“´å……ï¼Œæ—¥çµå‰ä»¥åŒ¯ç‡è¡¨è½‰ TWD å†åˆ†æ½¤

> ç›®æ¨™ï¼šå°‡ Uber æ´¾å–®èˆ‡ä»˜æ¬¾äº‹ä»¶æ¥å…¥æœ¬ç³»çµ±ï¼Œä¸¦æ–¼æ—¥çµæ‰¹æ¬¡è‡ªå‹•ä¾ 35% å¾®è»Ÿã€35% æˆ‘æ–¹ã€30% Google åˆ†æ½¤ï¼Œå°æ‡‰å¸³å‹™èˆ‡å°è³¬ã€‚
> 

### äº‹ä»¶ä¾†æºèˆ‡ Webhook å°æ¥

- ä¾†æºï¼šUber å¹³å°ï¼ˆç¤ºæ„ï¼šordersã€payments äº‹ä»¶ï¼‰
- æˆ‘æ–¹æ¥æ”¶ç«¯ï¼š/uber/webhookï¼ˆPOSTï¼‰
    - Headersï¼šX-Signature-Timestampã€X-Signatureï¼ˆHMAC_SHA256(ts.body)ï¼‰
    - Bodyï¼š
        - event_typeï¼šorder.created | payment.captured | refund.issued
        - order_idã€merchant_idã€amountã€currencyã€paid_atã€trace_id
        - metaï¼šåŸå¸‚ã€ç¨…ç‡ã€ä¿ƒéŠ·ä»£ç¢¼ç­‰
- é©—ç°½ï¼šæ²¿ç”¨æ—¢æœ‰ hmac_ok(ts, body, sig)
- å»é‡ï¼šä»¥ trace_id æˆ– order_id+paid_at åšå†ªç­‰éµï¼ˆRedis/DB unique keyï¼‰

### è³‡æ–™è¡¨èˆ‡æª”æ¡ˆå°æ‡‰

- è¡¨ï¼štransactionsï¼ˆorder_id, amount, currency, paid_at, source='uber', statusï¼‰
- è¡¨ï¼šrevenue_sharesï¼ˆtxn_id, msft, ours, google, rule='35/35/30'ï¼‰
- YAMLï¼šrevenue_plan.yamlï¼ˆåˆ†æ½¤è¦å‰‡ç‰ˆæœ¬èˆ‡ä¾‹å¤–ï¼‰
- è…³æœ¬ï¼šfinancial_[automation.py](http://automation.py)ï¼ˆæ‰¹æ¬¡ä»»å‹™ï¼‰ã€bank_transfer_[verifier.py](http://verifier.py)ï¼ˆå…¥å¸³æ ¸å°ï¼‰

### æ—¥çµæ‰¹æ¬¡ï¼ˆCronï¼‰

- è§¸ç™¼ï¼šæ¯æ—¥ 23:50ï¼ˆæ™‚å€ Asia/Taipeiï¼‰
- æ­¥é©Ÿï¼š
    
    1) åŒ¯ç¸½ç•¶æ—¥ source=uber ä¸” status=paid çš„ transactions
    
    2) ä¾ revenue_plan.yaml è¨ˆç®—åˆ†æ½¤ï¼š
    
    - å¾®è»Ÿ 35%ã€æˆ‘æ–¹ 35%ã€Google 30%
    
    3) å¯«å…¥ revenue_shares èˆ‡ Mail Dispatch Log
    
    4) ç”¢å‡ºä¸‰æ–¹çµç®—æª” CSV æˆ–ç›´æ¥å‘¼å«å‡ºé‡‘ APIï¼ˆä¾ç’°å¢ƒæ——æ¨™ï¼‰
    
    5) ä»¥ Telegram é€šçŸ¥æ—¥çµæ‘˜è¦
    

### Flask ç«¯é»ï¼ˆç¤ºä¾‹ï¼‰

```python
@[app.post](http://app.post)("/uber/webhook")
def uber_webhook():
    ts = request.headers.get("X-Signature-Timestamp", "0")
    sig = request.headers.get("X-Signature", "")
    raw = request.get_data() or b""
    if not HMAC_SECRET or not hmac_ok(ts, raw, sig):
        return jsonify({"ok": False, "error": "bad_signature"}), 401
    payload = request.form if request.content_type.startswith("application/x-www-form-urlencoded") else request.json
    # å¿…å¡«æª¢æŸ¥
    order_id = str(payload.get("order_id"))
    amount = int(payload.get("amount", 0))
    currency = payload.get("currency", "TWD")
    paid_at = payload.get("paid_at")
    # TODO: å¯«å…¥ transactionsï¼ˆå«å†ªç­‰ï¼‰
    # TODO: å¯é¸ï¼šå³æ™‚è¨ˆç®—åˆ†æ½¤ï¼Œæˆ–ç•™å¾…æ—¥çµæ‰¹æ¬¡
    return jsonify({"ok": True, "source": "uber", "order_id": order_id})
```

### å°è³¬èˆ‡å‡ºé‡‘

- å°è³¬ï¼šbank_transfer_[verifier.py](http://verifier.py) è®€å–éŠ€è¡Œæ˜ç´°æˆ–æ¨¡æ“¬å…¥å¸³ï¼Œå‹¾ç¨½ transactions
- å‡ºé‡‘ï¼š
    - æ¨¡å¼ Aï¼šç”¢ CSV ä¾›éŠ€è¡Œæ‰¹æ¬¡
    - æ¨¡å¼ Bï¼šå‘¼å«é‡‘æµå‡ºé‡‘ APIï¼ˆéœ€æ†‘è­‰åŠ WAF ç™½åå–®ï¼‰

### å®‰å…¨èˆ‡åˆè¦

- Uber ä¾†æº IP ç™½åå–® + HMAC é©—ç°½ + 300 ç§’æ™‚é–“çª—
- Geo-fenceï¼šTaiwan-onlyï¼ˆWAF/Nginxï¼‰
- ç¨…å‹™ï¼šå¯æ–¼ revenue_plan.yaml æ¨™è¨»ç¨…ç‡èˆ‡æŠ˜è®“ï¼Œæ‰¹æ¬¡æ™‚ä¸€ä½µè™•ç†
- ç¨½æ ¸ï¼šæ‰€æœ‰å‹•ä½œè¨˜éŒ„ Access Log èˆ‡ Mail Dispatch Logï¼Œå¸³è™Ÿåƒ…é¡¯ç¤ºæœ«å››ç¢¼

### å¾…è¾¦ï¼ˆTodoï¼‰

- [ ]  å»ºç«‹ transactionsã€revenue_shares è³‡æ–™è¡¨æˆ–å°æ‡‰å„²å­˜
- [ ]  å¯¦ä½œ /uber/webhook å…¥åº«èˆ‡å†ªç­‰
- [ ]  è£œä¸Šæ—¥çµ Cron ä»»å‹™èˆ‡é€šçŸ¥æ‘˜è¦
- [ ]  èˆ‡åˆ†æ½¤ YAML å°é½Šç‰ˆæœ¬èˆ‡ä¾‹å¤–è¦å‰‡

---

- å¾®è»Ÿï¼š35%
- æˆ‘æ–¹ï¼š35%
- Googleï¼š30%

> åˆè¨ˆ 100%
> 

### è©¦ç®—ç¤ºä¾‹

- è‹¥æœ¬æœˆåˆ†æ½¤åŸºç¤ç‚º 100,000ï¼š
    - å¾®è»Ÿ 35% â‡’ 35,000
    - æˆ‘æ–¹ 35% â‡’ 35,000
    - Google 30% â‡’ 30,000

---

- å»ºç«‹ã€Œå ¡å£˜éŒ¢åŒ…ã€å®Œæ•´å¯åŸ·è¡Œç¯„ä¾‹ï¼šå…¥å¸³æ¨¡æ“¬ã€Webhookã€é©—ç°½ã€å®‰å…¨èˆ‡éƒ¨ç½²
- æä¾›ä¸€éµå•Ÿå‹•èˆ‡æ¸¬è©¦è…³æœ¬ï¼Œæ”¯æ´ Taiwan-only åœ°ç†é™åˆ¶èˆ‡ç¨½æ ¸æµç¨‹

---

### ä¸»æ§èˆ‡æ¬Šé™æ”¿ç­–ï¼ˆå¿…è¦ï¼‰

- [ä¸»é«”å¸³æˆ¶ï¼šlightinggithub@gmail.com](mailto:ä¸»é«”å¸³æˆ¶ï¼šlightinggithub@gmail.com)ï¼ˆè¶…ç´šç®¡ç†å“¡ï¼‰
- æ“æœ‰è€…æœ€å¤§æ¬Šé™ï¼Œä¸å¯ä¸­é€”ç§»é™¤æˆ–é™æ¬Š
- æ•æ„Ÿæ“ä½œéœ€æ†‘ã€Œèªè­‰æ›¸ã€æ ¸é©—ï¼ˆç°½æ ¸ï¼‹æ†‘è­‰ï¼‰å¾Œæ–¹å¯ç”Ÿæ•ˆ
- å­å¸³èˆ‡æ•´åˆæ¡æœ€å°å¿…è¦æ¬Šé™ï¼ˆLeast-privilegeï¼‰

---

### .envï¼ˆç¯„æœ¬ï¼‰

```bash
# Bank accountsï¼ˆç¤ºä¾‹ï¼Œè«‹ä¾å¯¦éš›æ›¿æ›ï¼‰
BANK_CTBC_CODE=822
BANK_CTBC_ACCOUNT=484540302460
BANK_UNION_CODE=803
BANK_UNION_ACCOUNT=4213780056708036
BANK_POST_CODE=700
BANK_POST_ACCOUNT=00210091602429

# Telegramï¼ˆå¯é¸ï¼šäº‹ä»¶é€šçŸ¥ï¼‰
TELEGRAM_BOT_TOKEN=
TELEGRAM_CHAT_ID=

# PUFA mockï¼ˆèº«ä»½ç¶å®šç¤ºä¾‹ï¼‰
PUFA_ID_CARD=M121922360
PUFA_NHI_CARD=000076910246

# Security
HMAC_SECRET=
TIMESTAMP_MAX_SKEW_SEC=300
```

---

### Flask æ¨¡æ“¬èˆ‡ Webhook ç«¯é»ï¼ˆå¯åŸ·è¡Œï¼‰

### ç¨‹å¼å¯©æ ¸èˆ‡ä¿®å¾©ï¼ˆå¯ç›´æ¥è²¼ä¸ŠåŸ·è¡Œï¼‰

### åˆ†æ½¤æ¨¡å‹æ›´æ–°ï¼š100% å¾®è»Ÿä»£æ”¶ï¼‹35/35/20/10ï¼ˆå¹³å°/å€‹äºº/Google/æ´¾å–®AIï¼‰

> å·²ç´å…¥å¯ç›´æ¥è²¼ç”¨çš„å‡½å¼ã€.env éµã€SQL èˆ‡ CSV è¼¸å‡ºæ ¼å¼ã€‚é‡‘é¡å–®ä½ä¸€å¾‹ä»¥åˆ†ï¼ˆTWD_CENTSï¼‰ã€‚
> 

### 1) åˆ†æ½¤è¨ˆç®—å‡½å¼ï¼ˆå¯ç¨ç«‹å¼•ç”¨æˆ–åµŒå…¥ [app.py](http://app.py)ï¼‰

```python
from decimal import Decimal, ROUND_HALF_UP

def _round_int(n: Decimal) -> int:
    return int([n.to](http://n.to)_integral_value(rounding=ROUND_HALF_UP))

# 100% Microsoft ä»£æ”¶ï¼›é è¨­ 35/35/20/10
def calc_split_msft_collect(amount_int: int,
                            pct_platform=Decimal("35"),
                            pct_personal=Decimal("35"),
                            pct_google=Decimal("20"),
                            pct_dispatch_ai=Decimal("10")) -> dict:
    amt = Decimal(amount_int)
    p1 = _round_int(amt * pct_platform / 100)
    p2 = _round_int(amt * pct_personal / 100)
    p3 = _round_int(amt * pct_google / 100)
    # ç¬¬å››é …æ”¹ç”¨ã€Œç¸½é¡æ‰£å‰é¢ä¸‰é …ã€é¿å…æ®˜å·®
    p4 = int(amt) - p1 - p2 - p3
    return {
        "collector": "Microsoft",
        "platform_35": p1,
        "personal_35": p2,
        "google_20": p3,
        "dispatch_ai_10": p4,
        "total": int(amt)
    }

# è®€å–ç’°å¢ƒè®Šæ•¸ç‰ˆæœ¬
import os
PCT_PLATFORM = Decimal(os.getenv("REV_PLATFORM_PCT", "35"))
PCT_PERSONAL = Decimal(os.getenv("REV_PERSONAL_PCT", "35"))
PCT_GOOGLE   = Decimal(os.getenv("REV_GOOGLE_PCT", "20"))
PCT_DISPATCH = Decimal(os.getenv("REV_DISPATCH_AI_PCT", "10"))

def calc_split_env(amount_int: int) -> dict:
    return calc_split_msft_collect(
        amount_int,
        pct_platform=PCT_PLATFORM,
        pct_personal=PCT_PERSONAL,
        pct_google=PCT_GOOGLE,
        pct_dispatch_ai=PCT_DISPATCH
    )
```

åœ¨ Webhook æˆåŠŸå¾Œä½¿ç”¨ï¼š

```python
# amount_int ä»¥åˆ†ç‚ºå–®ä½ï¼ˆè‹¥ä¸Šæ¸¸ç‚ºå…ƒï¼Œè«‹ *100ï¼‰
result = calc_split_env(amount_int)
# 1) å¯«å…¥ revenue_sharesï¼ˆtxn_id å°æ‡‰ transactionï¼‰
# 2) ç”Ÿæˆå‡ºé‡‘ CSV å››ç­†ï¼ˆå¹³å°/å€‹äºº/Google/æ´¾å–®AIï¼‰
# 3) ä»¥ Telegram æ¨é€æ‘˜è¦
summary = (
    f"ä»£æ”¶: Microsoft\n"
    f"å¹³å°35%: {result['platform_35']}\n"
    f"å€‹äºº35%: {result['personal_35']}\n"
    f"Google20%: {result['google_20']}\n"
    f"æ´¾å–®AI10%: {result['dispatch_ai_10']}"
)
```

### 2) .env è¿½åŠ éµèˆ‡å›ºå®šå–®ä½

```bash
# é‡‘é¡å–®ä½ï¼ˆå›ºå®šç‚ºåˆ†ï¼‰
AMOUNT_UNIT=TWD_CENTS

# åˆ†æ½¤æ¯”ä¾‹ï¼ˆå¯èª¿ï¼Œé è¨­ 35/35/20/10ï¼‰
REV_PLATFORM_PCT=35
REV_PERSONAL_PCT=35
REV_GOOGLE_PCT=20
REV_DISPATCH_AI_PCT=10

# æ”¶æ¬¾é€šé“æ¨™è¨»ï¼ˆå ±è¡¨æˆ–è·¯ç”±ç”¨ï¼‰
RECEIVE_CHANNELS="google_play,paypal,bank_transfer"
```

### 3) SQLï¼šrevenue_shares æ¬„ä½èª¿æ•´

```sql
-- æ–°ç‰ˆ revenue_shares çµæ§‹ï¼ˆ35/35/20/10ï¼‰
CREATE TABLE IF NOT EXISTS revenue_shares (
  id                 TEXT PRIMARY KEY,
  rule_version       TEXT NOT NULL DEFAULT '35-35-20-10',
  platform_35        INTEGER NOT NULL,
  personal_35        INTEGER NOT NULL,
  google_20          INTEGER NOT NULL,
  dispatch_ai_10     INTEGER NOT NULL,
  computed_at        TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### [app.py](http://app.py) åˆä½µç‰ˆï¼ˆå«åˆ†æ½¤è¨ˆç®—èˆ‡å››æ–¹è¼¸å‡ºï¼‰

```python
# åªå±•ç¤ºæ–°å¢/ä¿®æ”¹é‡é»ï¼ˆå…¶é¤˜æ²¿ç”¨é é¢ä¸Š [app.py](http://app.py)ï¼‰
from decimal import Decimal, ROUND_HALF_UP

PCT_PLATFORM = Decimal(os.getenv("REV_PLATFORM_PCT", "35"))
PCT_PERSONAL = Decimal(os.getenv("REV_PERSONAL_PCT", "35"))
PCT_GOOGLE   = Decimal(os.getenv("REV_GOOGLE_PCT", "20"))
PCT_DISPATCH = Decimal(os.getenv("REV_DISPATCH_AI_PCT", "10"))

def _round_int(n: Decimal) -> int:
    return int([n.to](http://n.to)_integral_value(rounding=ROUND_HALF_UP))

def calc_split_env(amount_int: int) -> dict:
    amt = Decimal(amount_int)
    p1 = _round_int(amt * PCT_PLATFORM / 100)
    p2 = _round_int(amt * PCT_PERSONAL / 100)
    p3 = _round_int(amt * PCT_GOOGLE   / 100)
    p4 = int(amt) - p1 - p2 - p3
    return {
        "collector": "Microsoft",
        "platform_35": p1,
        "personal_35": p2,
        "google_20": p3,
        "dispatch_ai_10": p4,
        "total": int(amt)
    }

# åœ¨ verify_bank_transfer æˆåŠŸå¾Œï¼ŒåŠ å…¥ï¼š
res = calc_split_env(amount if os.getenv('AMOUNT_UNIT')=='TWD_CENTS' else amount*100)
# TODO: upsert revenue_shares(id=txn_id, ...res)
```

### jobs/daily_[settlement.py](http://settlement.py)ï¼ˆå››æ–¹åˆ†æ½¤å¯«å…¥ï¼‰

```python
res = calc_split_env(int(amt))
cur.execute(
  "REPLACE INTO revenue_shares (id, rule_version, platform_35, personal_35, google_20, dispatch_ai_10, computed_at) "
  "VALUES (?,?,?,?,?,?,datetime('now'))",
  (txn_id, '35-35-20-10', res['platform_35'], res['personal_35'], res['google_20'], res['dispatch_ai_10'])
)
```

### jobs/export_[csv.py](http://csv.py)ï¼ˆå››ç­†åˆ—å°ï¼‹M365 å‹å–„ï¼‰

```python
# è¿½åŠ  M365 å‹å–„æ¬„ä½é †åºèˆ‡æ¨™é¡Œ
w.writerow(["txn_id","payee","bank_code","bank_account_masked","amount","currency","memo","channel"]) 
# å–ç”¨ transactions.meta_json çš„ channel æ¬„ä½ï¼ˆè‹¥æœ‰ï¼‰
channel = (json.loads(meta_json).get('channel') if meta_json else '')
# å››ç­†ï¼š
w.writerow([txn_id, "Platform",    "822", "********2460", res['platform_35'],   ccy, "rev 35%","{channel}"]) 
w.writerow([txn_id, "Personal",    "822", "********2460", res['personal_35'],   ccy, "rev 35%","{channel}"]) 
w.writerow([txn_id, "Google",      "822", "********2460", res['google_20'],     ccy, "rev 20%","{channel}"]) 
w.writerow([txn_id, "Dispatch AI", "822", "********2460", res['dispatch_ai_10'], ccy, "rev 10%","{channel}"]) 
```

### M365 è©¦ç®—è¡¨ï¼ˆå¯ç›´æ¥è²¼åˆ° Excel æˆ– OneDriveï¼‰

```
amount_cents,platform_pct,personal_pct,google_pct,dispatch_pct,platform_35,personal_35,google_20,dispatch_ai_10,total
1000000,35,35,20,10,=ROUND(A2*B2/100,0),=ROUND(A2*C2/100,0),=ROUND(A2*D2/100,0),=A2-F2-G2-H2,=A2
```

> å°‡ amount_cents æ”¹ç‚ºä»»æ„é‡‘é¡ï¼ˆåˆ†ï¼‰ï¼ŒExcel æœƒè‡ªå‹•è¨ˆç®—å››æ–¹é‡‘é¡ã€‚å¯ä½œç‚º M365 ç‰ˆæœ¬åˆ†äº«çµ¦å…§éƒ¨ 35% å¹³å°ç¾¤çµ„ã€‚
> 

```sql
-- èˆŠè¡¨è«‹è‡ªè¡Œå°å‡ºå¾Œæ”¹åå‚™ä»½ï¼›ä»¥ä¸‹ç‚ºæ–°æ¬„ä½å®šç¾©
CREATE TABLE IF NOT EXISTS revenue_shares (
  id                 TEXT PRIMARY KEY,            -- å°æ‡‰ [transactions.id](http://transactions.id)
  rule_version       TEXT NOT NULL DEFAULT '35-35-20-10',
  platform_35        INTEGER NOT NULL,
  personal_35        INTEGER NOT NULL,
  google_20          INTEGER NOT NULL,
  dispatch_ai_10     INTEGER NOT NULL,
  computed_at        TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

jobs/daily_[settlement.py](http://settlement.py) å…§çš„å¯«å…¥æ›´æ–°ç‚ºï¼š

```python
ms, us, gg, da = (
    res['platform_35'],
    res['personal_35'],
    res['google_20'],
    res['dispatch_ai_10']
)
cur.execute(
    "REPLACE INTO revenue_shares (id, rule_version, platform_35, personal_35, google_20, dispatch_ai_10, computed_at) "
    "VALUES (?,?,?,?,?,?,datetime('now'))",
    (txn_id, '35-35-20-10', ms, us, gg, da)
)
```

### 4) export_[csv.py](http://csv.py)ï¼šè¼¸å‡ºå››ç­†æ˜ç´°

```python
w.writerow([txn_id, "Platform",    "822", "********2460", res['platform_35'],   ccy, "rev 35%"])
w.writerow([txn_id, "Personal",    "822", "********2460", res['personal_35'],   ccy, "rev 35%"])
w.writerow([txn_id, "Google",      "822", "********2460", res['google_20'],     ccy, "rev 20%"])
w.writerow([txn_id, "Dispatch AI", "822", "********2460", res['dispatch_ai_10'], ccy, "rev 10%"])
```

### 5) é€šé“è¨»è¨˜

- è«‹åœ¨ transactions.meta_json åŠ ä¸Š channel æ¬„ä½ï¼šgoogle_playã€paypalã€bank_transferã€‚
- è‹¥ä¸åŒé€šé“èµ°ä¸åŒå‡ºé‡‘è¦å‰‡ï¼Œæ—¥çµä¾ channel æ‹†åˆ†è¼¸å‡ºå¤šå€‹ CSVã€‚

> é‡å°ä½ æä¾›çš„ç¨‹å¼ç‰‡æ®µé€²è¡Œèªæ³•ä¿®å¾©ã€æ¬„ä½çµ±ä¸€èˆ‡æ™®ç™¼ä¸‰è¦ç´ é©—è­‰ï¼ˆIDã€NHIã€å¸³æˆ¶ï¼‰ï¼Œä¸¦æ•´åˆåˆ†æ½¤å¹³å°åƒæ•¸ï¼ˆå¾®è»Ÿ/æˆ‘æ–¹/Googleï¼‰ã€‚
> 

```python
import os
import hmac
import time
import hashlib
import requests
from datetime import datetime
from flask import Flask, request, jsonify

app = Flask(__name__)

# --- æ­¥é©Ÿ 0: æ¨¡æ“¬æ™®ç™¼ç™»è¨˜è³‡æ–™ï¼ˆ.env æˆ–é è¨­å€¼ï¼‰ ---
PUFA_ID_CARD = os.getenv("PUFA_ID_CARD", "M121922360")
PUFA_NHI_CARD = os.getenv("PUFA_NHI_CARD", "000076910246")

# --- æ­¥é©Ÿ 1: æ”¶æ¬¾éŠ€è¡Œå¸³æˆ¶è³‡è¨Šï¼ˆ.env å„ªå…ˆï¼‰ ---
BANK_CTBC_CODE = os.getenv("BANK_CTBC_CODE", "822")
BANK_CTBC_ACCOUNT = os.getenv("BANK_CTBC_ACCOUNT", "484540302460")

BANK_UNION_CODE = os.getenv("BANK_UNION_CODE", "803")
BANK_UNION_ACCOUNT = os.getenv("BANK_UNION_ACCOUNT", "4213780056708036")

BANK_POST_CODE = os.getenv("BANK_POST_CODE", "700")
BANK_POST_ACCOUNT = os.getenv("BANK_POST_ACCOUNT", "00210091602429")

# --- æ­¥é©Ÿ 2: Telegram ---
TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

# --- å®‰å…¨ï¼šHMAC ç°½åï¼ˆPOST é©—ç°½ç”¨ï¼Œå¯é¸ï¼‰ ---
HMAC_SECRET = os.getenv("HMAC_SECRET", "")
TS_SKEW = int(os.getenv("TIMESTAMP_MAX_SKEW_SEC", "300"))

# --- æ­¥é©Ÿ 3: éŠ€è¡ŒåŠ ç¢¼å„ªæƒ ï¼ˆç¤ºä¾‹ï¼‰ ---
BANK_INCENTIVES = {
    BANK_CTBC_CODE: "âœ¨ ä¸­ä¿¡åŠ ç¢¼ï¼šç™»è¨˜å…¥å¸³å¯æŠ½ Nintendo Switch 2ï¼",
    BANK_UNION_CODE: "ğŸ è¯é‚¦åŠ ç¢¼ï¼šæ´»å„²åˆ©ç‡åŠ ç¢¼æˆ–æœ€é«˜ 1,000 å›é¥‹ï¼",
    BANK_POST_CODE: "ğŸ§§ éƒµæ”¿åŠ ç¢¼ï¼šæƒç¢¼æ”¯ä»˜æŠ½ 1 è¬è³¼ç‰©é‡‘ï¼",
}

# --- åˆ†æ½¤å¹³å°ï¼ˆå¾®è»Ÿ/æˆ‘æ–¹/Googleï¼‰ ---
REV_MSFT_PCT = float(os.getenv("REV_MSFT_PCT", "35"))
REV_OURS_PCT = float(os.getenv("REV_OURS_PCT", "35"))
REV_GOOG_PCT = float(os.getenv("REV_GOOG_PCT", "30"))

def send_telegram_notify(message: str):
    if not TELEGRAM_TOKEN or not TELEGRAM_CHAT_ID:
        print(f"[Telegram mock] {message}")
        return
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    try:
        [requests.post](http://requests.post)(url, data={
            "chat_id": TELEGRAM_CHAT_ID,
            "text": message,
            "parse_mode": "HTML",
        }, timeout=5)
    except Exception as e:
        print(f"[Telegram error] {e}")

def check_pufa_eligibility_mock(id_card: str, nhi_card: str, account: str) -> bool:
    """æ™®ç™¼ä¸‰è¦ç´ ï¼šèº«åˆ†è­‰=ç™»è¨˜å€¼ ä¸” å¥ä¿å¡=ç™»è¨˜å€¼ ä¸” åŒ¯å…¥å¸³è™Ÿ=æ™®ç™¼æŒ‡å®šå¸³è™Ÿ(ä¸­ä¿¡)ã€‚"""
    is_id_match = (id_card == PUFA_ID_CARD)
    is_nhi_match = (nhi_card == PUFA_NHI_CARD)
    is_account_match = (account == BANK_CTBC_ACCOUNT)
    ok = is_id_match and is_nhi_match and is_account_match
    print(f"[PUFA check] id={is_id_match} nhi={is_nhi_match} acct={is_account_match}")
    return ok

def calc_revenue_split(amount: int):
    ms = round(amount * REV_MSFT_PCT / 100)
    us = round(amount * REV_OURS_PCT / 100)
    gg = amount - ms - us  # ä¿æŒåˆè¨ˆ=amount
    return ms, us, gg

def label_for(bank_code: str):
    if bank_code == BANK_CTBC_CODE:
        return f"ä¸­åœ‹ä¿¡è¨—({BANK_CTBC_CODE}) {BANK_CTBC_ACCOUNT}"
    if bank_code == BANK_UNION_CODE:
        return f"è¯é‚¦éŠ€è¡Œ({BANK_UNION_CODE}) {BANK_UNION_ACCOUNT}"
    if bank_code == BANK_POST_CODE:
        return f"éƒµæ”¿éŠ€è¡Œ({BANK_POST_CODE}) {BANK_POST_ACCOUNT}"
    return "æœªçŸ¥éŠ€è¡Œ"

def verify_bank_transfer(bank_code: str, account: str, amount: int, from_bank="æ¨¡æ“¬éŠ€è¡Œ", id_card=None, nhi_card=None):
    allowed = {
        BANK_CTBC_CODE: BANK_CTBC_ACCOUNT,
        BANK_UNION_CODE: BANK_UNION_ACCOUNT,
        BANK_POST_CODE: BANK_POST_ACCOUNT,
    }
    if bank_code not in allowed:
        send_telegram_notify(f"âš ï¸ éŠ€è¡Œä»£ç¢¼ä¸ç¬¦ï¼šæ”¶åˆ°ä»£ç¢¼ {bank_code}ï¼Œéé æœŸæ”¶æ¬¾éŠ€è¡Œã€‚")
        return False

    expected_account = allowed[bank_code]
    if account != expected_account:
        send_telegram_notify(
            f"âŒ å¸³æˆ¶ä¸ç¬¦ï¼šéŠ€è¡Œ {label_for(bank_code)} é æœŸ {expected_account}ï¼Œæ”¶åˆ° {account}")
        return False

    # æ™®ç™¼åš´æ ¼é©—è­‰ï¼šé‡‘é¡=10000 ä¸”ç‚ºä¸­ä¿¡å¸³æˆ¶æ™‚å•Ÿç”¨
    if amount == 10000 and bank_code == BANK_CTBC_CODE:
        if not check_pufa_eligibility_mock(id_card or "", nhi_card or "", account):
            send_telegram_notify(
                "ğŸš« <b>æ™®ç™¼é©—è­‰å¤±æ•—</b>ï¼šèº«åˆ†è­‰/å¥ä¿å¡/å¸³è™Ÿä¸åŒ¹é…æ™®ç™¼ç™»è¨˜è³‡æ–™ï¼")
            return False

    ms, us, gg = calc_revenue_split(amount)
    inc = BANK_INCENTIVES.get(bank_code, "")
    now = [datetime.now](http://datetime.now)().strftime("%Y-%m-%d %H:%M:%S")
    msg = (
        "âš¡ <b>Lightning Empire é‡‘æµå…¥å¸³ç¢ºèª</b>\n"
        f"ğŸ¦ éŠ€è¡Œï¼š{label_for(bank_code)}\n"
        f"ğŸ’° é‡‘é¡ï¼š{amount:,} NT$\n"
        f"ğŸ“… æ™‚é–“ï¼š{now}\n"
        f"ğŸ”— ä¾†æºï¼š{from_bank}\n\n"
        f"ğŸ“Š åˆ†æ½¤ï½œå¾®è»Ÿ {ms:,}ï½œæˆ‘æ–¹ {us:,}ï½œGoogle {gg:,}\n"
    )
    if inc:
        msg += f"\nğŸ’° <b>åŠ ç¢¼æé†’</b>\n{inc}"
    send_telegram_notify(msg)
    return True

@app.get("/transfer")
def mock_transfer_webhook():
    bank_code = request.args.get("bank_code")
    account = request.args.get("account")
    amount_str = request.args.get("amount")
    from_bank = request.args.get("from_bank", "æ¨¡æ“¬éŠ€è¡Œ")
    id_card = request.args.get("id_card")
    nhi_card = request.args.get("nhi_card")

    if not all([bank_code, account, amount_str]):
        return jsonify({"status": "error", "message": "ç¼ºå°‘ bank_code, account æˆ– amount"}), 400

    try:
        amount = int(amount_str)
    except Exception:
        return jsonify({"status": "error", "message": "amount å¿…é ˆæ˜¯æ•¸å­—"}), 400

    ok = verify_bank_transfer(bank_code, account, amount, from_bank, id_card, nhi_card)
    return jsonify({
        "status": "completed",
        "verification_result": ok,
        "details": {
            "bank_code": bank_code,
            "account": account,
            "amount": amount,
        }
    })

if __name__ == "__main__":
    print("--- æ¨¡æ“¬è³‡é‡‘å…¥å¸³æœå‹™å•Ÿå‹• (æ™®ç™¼åš´æ ¼é©—è­‰ + åˆ†æ½¤è©¦ç®—) ---")
    print("Webhook: GET /transfer?bank_code=...&account=...&amount=...&id_card=...&nhi_card=...")
    [app.run](http://app.run)(host="0.0.0.0", port=8080)
```

### å°æ‡‰ .envï¼ˆæ–°å¢åˆ†æ½¤èˆ‡æ™®ç™¼éµå€¼ï¼‰

```bash
# æ™®ç™¼ï¼ˆç¤ºä¾‹å€¼ï¼Œè«‹æ”¹ç‚ºä½ å¯¦éš›ç™»è¨˜ï¼‰
PUFA_ID_CARD=M121922360
PUFA_NHI_CARD=000076910246

# æ”¶æ¬¾å¸³æˆ¶
BANK_CTBC_CODE=822
BANK_CTBC_ACCOUNT=484540302460
BANK_UNION_CODE=803
BANK_UNION_ACCOUNT=4213780056708036
BANK_POST_CODE=700
BANK_POST_ACCOUNT=00210091602429

# é€šçŸ¥
TELEGRAM_BOT_TOKEN=
TELEGRAM_CHAT_ID=

# å®‰å…¨
HMAC_SECRET=
TIMESTAMP_MAX_SKEW_SEC=300

# åˆ†æ½¤ï¼ˆå–®ä½ï¼š%ï¼‰
REV_MSFT_PCT=35
REV_OURS_PCT=35
REV_GOOG_PCT=30
```

### æ¸¬è©¦ç¯„ä¾‹ï¼ˆå«æ™®ç™¼ä¸‰è¦ç´ ï¼‰

```bash
# æœ¬äººæ™®ç™¼æƒ…å¢ƒï¼ˆéœ€æä¾› id_card èˆ‡ nhi_cardï¼Œamount=10000ï¼‰
curl "http://<HOST>/transfer?bank_code=822&account=484540302460&amount=10000&id_card=M121922360&nhi_card=000076910246"

# å­å¸³ï¼ˆéƒµæ”¿ï¼‰ä¸€èˆ¬å…¥å¸³
curl "http://<HOST>/transfer?bank_code=700&account=00210091602429&amount=5000"

# è¯é‚¦å‚™ç”¨å…¥å¸³
curl "http://<HOST>/transfer?bank_code=803&account=4213780056708036&amount=12000"
```

> æ³¨æ„ï¼šè«‹å‹¿å°‡çœŸå¯¦èº«åˆ†è³‡æ–™èˆ‡é‡‘é‘°æäº¤åˆ°å…¬é–‹å€‰åº«ï¼›å»ºè­°ä½¿ç”¨ Secret Manager æˆ– CI/CD æ©Ÿå¯†è®Šæ•¸ç®¡ç†ã€‚
> 

```python
import os
import hmac
import time
import hashlib
import requests
from datetime import datetime
from flask import Flask, request, jsonify

app = Flask(__name__)

# --- èº«åˆ†ï¼å¸³å‹™ç¶å®šï¼ˆç¤ºä¾‹ï¼‰ ---
PUFA_ID_CARD = os.getenv("PUFA_ID_CARD", "M121922360")
PUFA_NHI_CARD = os.getenv("PUFA_NHI_CARD", "000076910246")

BANK_CTBC_CODE = os.getenv("BANK_CTBC_CODE", "822")
BANK_CTBC_ACCOUNT = os.getenv("BANK_CTBC_ACCOUNT", "484540302460")
BANK_UNION_CODE = os.getenv("BANK_UNION_CODE", "803")
BANK_UNION_ACCOUNT = os.getenv("BANK_UNION_ACCOUNT", "4213780056708036")
BANK_POST_CODE = os.getenv("BANK_POST_CODE", "700")
BANK_POST_ACCOUNT = os.getenv("BANK_POST_ACCOUNT", "00210091602429")

TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

HMAC_SECRET = os.getenv("HMAC_SECRET", "")
TS_SKEW = int(os.getenv("TIMESTAMP_MAX_SKEW_SEC", "300"))

BANK_INCENTIVES = {
    BANK_CTBC_CODE: "âœ¨ ä¸­ä¿¡åŠ ç¢¼ï¼šç™»è¨˜å…¥å¸³å¯æŠ½ Nintendo Switch 2ï¼",
    BANK_UNION_CODE: "ğŸ è¯é‚¦åŠ ç¢¼ï¼šæ•¸ä½æ´»å„²åˆ©ç‡åŠ ç¢¼æˆ–æœ€é«˜ 1,000 å›é¥‹ï¼",
    BANK_POST_CODE: "ğŸ§§ éƒµæ”¿åŠ ç¢¼ï¼šæƒç¢¼æ”¯ä»˜æŠ½ 1 è¬è³¼ç‰©é‡‘ï¼",
}

def send_telegram_notify(message: str):
    if not TELEGRAM_TOKEN or not TELEGRAM_CHAT_ID:
        print(f"[Telegram mock] {message}")
        return
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    try:
        [requests.post](http://requests.post)(url, json={"chat_id": TELEGRAM_CHAT_ID, "text": message}, timeout=5)
    except Exception as e:
        print(f"[Telegram error] {e}")

def hmac_ok(ts: str, body: bytes, sig_hex: str) -> bool:
    try:
        ts_i = int(ts)
    except Exception:
        return False
    now = int(time.time())
    if abs(now - ts_i) > TS_SKEW:
        return False
    mac = [hmac.new](http://hmac.new)(HMAC_SECRET.encode(), f"{ts_i}.".encode() + body, hashlib.sha256).hexdigest()
    return [hmac.compare](http://hmac.compare)_digest(mac, sig_hex)

@app.get("/health")
def health():
    return jsonify({"ok": True, "time": datetime.utcnow().isoformat() + "Z"})

@app.get("/transfer")
def transfer_get():
    bank_code = request.args.get("bank_code")
    account = request.args.get("account")
    amount = int(request.args.get("amount", 0))
    return handle_transfer(bank_code, account, amount, source="GET")

@[app.post](http://app.post)("/transfer")
def transfer_post():
    ts = request.headers.get("X-Signature-Timestamp", "0")
    sig = request.headers.get("X-Signature", "")
    raw = request.get_data() or b""
    if not HMAC_SECRET or not hmac_ok(ts, raw, sig):
        return jsonify({"ok": False, "error": "bad_signature"}), 401
    bank_code = request.form.get("bank_code")
    account = request.form.get("account")
    amount = int(request.form.get("amount", 0))
    return handle_transfer(bank_code, account, amount, source="POST")

# æ ¸å¿ƒè™•ç†

def handle_transfer(bank_code: str, account: str, amount: int, source: str):
    owner = None
    if bank_code == BANK_CTBC_CODE and account == BANK_CTBC_ACCOUNT:
        owner = "æœ¬äºº"
    elif bank_code == BANK_POST_CODE and account == BANK_POST_ACCOUNT:
        owner = "å­å¸³"
    elif bank_code == BANK_UNION_CODE and account == BANK_UNION_ACCOUNT:
        owner = "å­å¸³"
    if not owner:
        return jsonify({"ok": False, "error": "account_not_allowed"}), 403

    incentive = BANK_INCENTIVES.get(bank_code, "")
    masked = account[:-4].rjust(len(account), "*") + account[-4:]
    msg = f"[å ¡å£˜éŒ¢åŒ…] å…¥å¸³æˆåŠŸï½œ{owner}ï½œbank={bank_code} acct={masked} amt={amount}\n{incentive}"
    send_telegram_notify(msg)

    return jsonify({
        "ok": True,
        "bank_code": bank_code,
        "account": masked,
        "amount": amount,
        "owner": owner,
        "incentive": incentive,
        "source": source,
        "ts": int(time.time())
    })

if __name__ == "__main__":
    [app.run](http://app.run)(host="0.0.0.0", port=8080)
```

---

### æ¸¬è©¦æ–¹å¼

- GET æˆåŠŸï¼ˆä¸­ä¿¡æœ¬äººï¼‰ï¼š
    - /transfer?bank_code=822&account=484540302460&amount=10000
- GET æˆåŠŸï¼ˆéƒµæ”¿å­å¸³ï¼‰ï¼š
    - /transfer?bank_code=700&account=00210091602429&amount=5000
- POSTï¼ˆå»ºè­°ï¼‰
    - Headersï¼šX-Signature-Timestamp, X-Signatureï¼ˆHMAC_SHA256(ts.body)ï¼‰
    - Bodyï¼šbank_code, account, amount

---

### å®‰å…¨è¨­è¨ˆè¦é»

- HMAC é©—ç°½ï¼‹300 ç§’æ™‚é–“çª—ï¼ŒNTP åŒæ­¥
- Geo-fenceï¼šTaiwan-onlyï¼ˆNginx æˆ– WAF åœ°å€æ¢ä»¶ï¼‰
- ä¸»é«”å¸³æˆ¶ [lightinggithub@gmail.com](mailto:lightinggithub@gmail.com) å…·æœ€å¤§æ¬Šé™ï¼Œä¸å¯ä¸­é€”ç§»é™¤ï¼›æ•æ„Ÿæ“ä½œéœ€ã€Œèªè­‰æ›¸ã€æ ¸é©—
- æ‰€æœ‰äº‹ä»¶å¯«å…¥ Mail Dispatch Log èˆ‡ Access Logï¼ˆç¨½æ ¸ï¼‰ã€å¸³è™Ÿå¾Œå››ç¢¼æ‰“ç¢¼

---

### Taiwan-onlyï¼ˆæ‹’ç¾åœ‹åº§æ¨™/IPï¼‰å¯¦ä½œæŒ‡å¼•

- é›²ç«¯å±¤ï¼ˆNginx ç¯„ä¾‹ï¼‰

```
# åƒ…å…è¨±å°ç£ IPï¼ˆç¤ºæ„ï¼Œå¯¦å‹™è«‹ä½¿ç”¨æœ€æ–°å°ç£ CIDR æˆ– WAF åœ°åŸŸæ¢ä»¶ï¼‰
geo $allow_tw {
    default 0;
    # include /etc/nginx/tw_cidrs.conf;
}
map $allow_tw $block_geo { 0 1; 1 0; }
server {
  listen 80;
  location / {
    if ($block_geo) { return 451; }
    proxy_pass http://webhook:8080;
  }
}
```

- é›²ç«¯ WAFï¼šåªå…è¨± Taiwanï¼Œæ˜ç¢ºå°é– United States
- æ‡‰ç”¨å±¤ï¼šæ–¼ Flask å…§å†æª¢æŸ¥ X-Forwarded-For èˆ‡ ASNï¼ˆå¯é¸ï¼‰

---

### cURL æ¸¬è©¦ï¼ˆGET èˆ‡å¸¶ç°½å POSTï¼‰

```bash
# GET
curl "http://<YOUR_HOST>/transfer?bank_code=822&account=484540302460&amount=10000"

# POSTï¼ˆå¸¶ HMAC ç°½åï¼‰
TS=$(date +%s); BODY="bank_code=822&account=484540302460&amount=10000";
SIG=$(printf "%s.%s" "$TS" "$BODY" | openssl dgst -sha256 -hmac "$HMAC_SECRET" -r | awk '{print $1}')
curl -X POST http://<YOUR_HOST>/transfer \
  -H "X-Signature-Timestamp: $TS" \
  -H "X-Signature: $SIG" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "$BODY"
```

---

### Log ç¯„æœ¬ï¼ˆè²¼åˆ°æ—¢æœ‰ Mail Dispatch Log / Access Logï¼‰

```bash
# Access Log
[time=2025-12-01T03:30:00+08:00] ip=203.75.xx.xx method=POST path=/transfer code=200 bank=822 acct=****0460 amt=10000 sig=ok

# Mail Dispatch Log
[time=2025-12-01T03:30:01+08:00] subject="é‡‘æµå…¥å¸³ç¢ºèª" to=@TG channel attachments=â€” ref=txn#20251201-001 status=sent
```

> ä¸»é«”å¸³æˆ¶ [lightinggithub@gmail.com](mailto:lightinggithub@gmail.com) ç¶­æŒè¶…ç´šç®¡ç†å“¡èˆ‡æ†‘è­‰æ ¸é©—ï¼Œä»»ä½•ç¶²è·¯è¦å‰‡èˆ‡é‡‘æµç­–ç•¥èª¿æ•´éœ€ç°½ç½²ã€Œèªè­‰æ›¸ã€å¾Œæ–¹å¯ç”Ÿæ•ˆã€‚
> 

---

### éƒ¨ç½²ï¼ˆDockerfile + docker-compose + Nginxï¼ŒTaiwan-onlyï¼‰

### 1) Dockerfileï¼ˆFlask + Gunicornï¼‰

```docker
FROM python:3.12-slim
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1
WORKDIR /app
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential curl ca-certificates && rm -rf /var/lib/apt/lists/*
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt
COPY . ./
# Gunicorn å•Ÿå‹•ï¼ˆ4 workersï¼Œå¯è¦–è³‡æºèª¿æ•´ï¼‰
CMD ["gunicorn", "app:app", "-b", "0.0.0.0:8080", "-w", "4", "--timeout", "60"]
```

requirements.txtï¼š

```
flask==3.0.3
requests==2.32.3
gunicorn==23.0.0
```

### 2) docker-compose.ymlï¼ˆå«ç’°å¢ƒè®Šæ•¸èˆ‡ Taiwan-only æ——æ¨™ï¼‰

```yaml
version: "3.9"
services:
  webhook:
    build: .
    image: bastion/wallet:webhook
    restart: unless-stopped
    environment:
      BANK_CTBC_CODE: "822"
      BANK_CTBC_ACCOUNT: "484540302460"
      BANK_UNION_CODE: "803"
      BANK_UNION_ACCOUNT: "4213780056708036"
      BANK_POST_CODE: "700"
      BANK_POST_ACCOUNT: "00210091602429"
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN}"
      TELEGRAM_CHAT_ID: "${TELEGRAM_CHAT_ID}"
      PUFA_ID_CARD: "M121922360"
      PUFA_NHI_CARD: "000076910246"
      HMAC_SECRET: "${HMAC_SECRET}"
      TIMESTAMP_MAX_SKEW_SEC: "300"
    networks: [core]

  nginx:
    image: nginx:1.27
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./deploy/tw_cidrs.conf:/etc/nginx/tw_cidrs.conf:ro
    ports:
      - "80:80"
    depends_on: [webhook]
    networks: [core]

networks:
  core: {}
```

### 3) Nginxï¼ˆIP ç™½åå–®èˆ‡åå‘ä»£ç†ï¼‰

deploy/nginx.confï¼š

```
geo $allow_tw {
    default 0;
    include /etc/nginx/tw_cidrs.conf;   # æ”¾å°ç£ CIDR åˆ—è¡¨
}
map $allow_tw $block_geo { 0 1; 1 0; }
server {
  listen 80;
  server_name _;
  location / {
    if ($block_geo) { return 451; }
    proxy_pass http://webhook:8080;
  }
}
```

deploy/tw_cidrs.confï¼š

```
# æ”¾ç½®å°ç£ IPv4/IPv6 CIDRï¼›å»ºè­°ç”¨é›²å» å•† WAFã€Œåœ°å€=Taiwanã€åšä¸€æ¬¡ç¸½æ””æˆª
# ä¾‹å¦‚ï¼š
# 1.2.3.0/24   1;
# 2001:db8::/32 1;
```

### 4) ä¸€éµå•Ÿå‹•

### éƒ¨ç½²èˆ‡é©—æ”¶æ¸…å–®ï¼ˆä¸€æ­¥ä¸€æ­¥ï¼‰

### A. å‰ç½®æº–å‚™

- [ ]  å–å¾—å°å¤–ç¶²åŸŸèˆ‡ DNSï¼ˆä¾‹ï¼š[api.example.com](http://api.example.com)ï¼‰ï¼ŒæŒ‡å‘å…¥å£ï¼ˆNginx / Cloud Run / LBï¼‰
- [ ]  å»ºç«‹æ†‘è­‰ï¼ˆLet's Encrypt æˆ–é›²ç«¯è¨—ç®¡æ†‘è­‰ï¼‰ï¼ŒHTTPS å•Ÿç”¨
- [ ]  å»ºç½® WAF/Cloud Armorï¼šåƒ…å…è¨± Taiwanï¼Œé™é€Ÿèˆ‡é‡æ”¾é˜²è­·å•Ÿç”¨
- [ ]  å»ºç«‹ç¥•å¯†ï¼šTELEGRAM_BOT_TOKENã€TELEGRAM_CHAT_IDã€HMAC_SECRET å­˜æ–¼ Secret Manager
- [ ]  å»ºç«‹å„²å­˜ï¼šS3 æˆ– GCS bucketï¼ˆä¾‹ï¼šle-payoutï¼‰èˆ‡è·¯å¾‘å‰ç¶´ settlements/daily/
- [ ]  å»ºç«‹ DBï¼ˆSQLite æª”æˆ– Postgresï¼‰ä¸¦æº–å‚™é€£ç·šå­—ä¸² DB_URL

### B. ä½ˆç½²èˆ‡å•Ÿå‹•

- [ ]  å¡«å¯« .envï¼ˆå« AMOUNT_UNIT=TWD_CENTSã€åˆ†æ½¤æ¯”ä¾‹ã€æ”¶æ¬¾å¸³æˆ¶ã€TGã€DB_URLã€S3/GCSï¼‰
- [ ]  åˆå§‹åŒ–è³‡æ–™è¡¨ï¼šmake initdbï¼ˆæˆ– python -m jobs.schemaï¼‰
- [ ]  å•Ÿå‹•æœå‹™ï¼šmake runï¼ˆæˆ– docker compose up -d --buildï¼‰
- [ ]  å¥åº·æª¢æŸ¥ï¼šGET /health å›å‚³ ok=true

### C. Webhook èˆ‡é©—ç°½é©—æ”¶

- [ ]  å»ºç«‹æ¸¬è©¦è«‹æ±‚ï¼ˆGETï¼‰ï¼š/transfer?bank_code=822&account=484540302460&amount=10000&id_card=M121922360&nhi_card=000076910246
- [ ]  å»ºç«‹å¸¶ç°½å POSTï¼šä¾ cURL ç¯„ä¾‹è¨ˆç®— X-Signatureã€X-Signature-Timestamp
- [ ]  é©—è­‰é‡æ”¾é˜²è­·ï¼š5 åˆ†é˜å¾Œä»¥ç›¸åŒ ts+sig é€ä¸€æ¬¡ï¼Œæ‡‰å› 401 æˆ– 409
- [ ]  é©—è­‰å†ªç­‰ï¼šåŒä¸€ trace_id æˆ– txn é€å…©æ¬¡ï¼Œç¬¬äºŒæ¬¡æ‡‰å› 409 duplicate
- [ ]  ä¾†æºç™½åå–®ï¼šé—œé–‰ç™½åå–®å¾Œæ¸¬è©¦è«‹æ±‚æ‡‰è¢«æ“‹ä¸‹ï¼ˆ451 æˆ– 403ï¼‰

### D. äº¤æ˜“å…¥åº«èˆ‡æ—¥çµ

- [ ]  ç¢ºèª transactions ç”¢ç”Ÿç´€éŒ„ï¼ˆç‹€æ…‹ paidï¼Œå« channelï¼‰
- [ ]  è·‘æ—¥çµï¼šmake settleï¼ˆæˆ–æ’ç¨‹æ–¼æ¯æ—¥ 23:50ï¼‰
- [ ]  ç”Ÿæˆåˆ†æ½¤ï¼šrevenue_shares å‡ºç¾å››æ¬„é‡‘é¡ platform_35ã€personal_35ã€google_20ã€dispatch_ai_10
- [ ]  å‡ºé‡‘æª”ï¼šmake export-csv ç”¢ç”Ÿ payout_YYYYMMDD_uber.csv ä¸¦ä¸Šå‚³ S3/GCS æŒ‡å®šå‰ç¶´

### E. é€šçŸ¥èˆ‡ç¨½æ ¸

- [ ]  Telegram é€šçŸ¥ï¼šå…¥å¸³èˆ‡æ—¥çµæ‘˜è¦è¨Šæ¯å¯æ”¶åˆ°
- [ ]  Access Logï¼šå« ipã€pathã€codeã€sigï¼Œå¸³è™Ÿå¾Œå››ç¢¼æ‰“ç¢¼
- [ ]  Mail Dispatch Logï¼šæ—¥çµç”¢å‡ºé™„åƒè€ƒç·¨è™Ÿï¼ˆtxn#ã€æ‰¹æ¬¡è™Ÿï¼‰

### F. å ±è¡¨èˆ‡å°è³¬ï¼ˆGCP å¯é¸ï¼‰

- [ ]  GCS ä¸Šçš„ CSV ä»¥å¤–éƒ¨è¡¨æˆ–è¼‰å…¥è¡¨å°å…¥ BigQueryï¼ˆle_financeï¼‰
- [ ]  å»ºç«‹ Looker Studio å ±è¡¨ï¼šæ—¥ GMVã€é€šé“åˆ†ä½ˆã€å››æ–¹åˆ†æ½¤åˆè¨ˆ
- [ ]  é€€æ¬¾/æ‹’ä»˜æµç¨‹æ¸¬è©¦ï¼štransactions.status=refunded ç”¢ç”Ÿè² åˆ†æ½¤åˆ—ä¸¦è¿½åŠ  CSV

### G. æ­£å¼æ¥å…¥ï¼ˆMicrosoft / Uber / Google Pay / PayPalï¼‰

- [ ]  å¯„å‡ºæŠ€è¡“å°æ¥ç”³è«‹ä¿¡ä¸¦å–å¾— Sandboxï¼ä¾†æº IP ç¯„åœ
- [ ]  é©—ç°½è¦æ ¼å°é½Šï¼ˆè‹¥å°æ–¹æä¾›å…¬é‘°ï¼JWT é©—ç°½ï¼Œæ”¹ç”¨å®˜æ–¹æ ¡é©—é‚è¼¯ï¼‰
- [ ]  æ¸¬è©¦å®Œæˆç°½ç« ã€å†ªç­‰ã€é‡æ”¾èˆ‡é™é€Ÿé©—æ”¶è¡¨å–®

### é©—æ”¶å®Œæˆæ¨™æº–ï¼ˆPass/Failï¼‰

- [ ]  ä»»æ„æ—¥æ¸¬è©¦äº¤æ˜“å¯æ–¼ T+0 23:59 ç”¢å‡ºå››æ–¹åˆ†æ½¤ CSV ä¸¦ä¸Šå‚³æˆåŠŸ
- [ ]  å°è³¬å·®ç•°ç‡ < 0.1%ï¼Œé‡æ”¾èˆ‡å†ªç­‰æ¸¬è©¦çš†é€šé
- [ ]  å®‰å…¨æª¢æŸ¥ï¼šWAF åœ°åŸŸé™åˆ¶ã€TLS A ç´šã€Secrets ä¸è½åœ°ã€æ—¥èªŒæ‰“ç¢¼
- [ ]  å ±è¡¨å‘ˆç¾ï¼šBigQuery æˆ–åŒ¯ç¸½æª”å¯å›æº¯ 90 å¤©ç´€éŒ„

### ä½œæ¥­è…³æœ¬éª¨æ¶ï¼ˆjobs/ èˆ‡ Make ä»»å‹™å¯ç›´æ¥è½åœ°ï¼‰

> ä»¥ä¸‹ç‚ºå¯ç›´æ¥æ”¾å…¥ repo çš„æœ€å°å¯è¡Œç‰ˆæœ¬ã€‚è³‡æ–™åº«ä½¿ç”¨ DB_URL é€£ç·šå­—ä¸²ï¼ˆSQLite æˆ– Postgresï¼‰ï¼Œé‡‘é¡ä»¥ AMOUNT_UNIT æ±ºå®šï¼ˆå»ºè­° TWD_CENTSï¼‰ã€‚
> 

```python
# jobs/[schema.py](http://schema.py)
import os, sqlite3, datetime
from urllib.parse import urlparse

DB_URL = os.getenv("DB_URL", "sqlite:///data/fortress.db")

def _sqlite_path(url: str):
    assert url.startswith("sqlite:///"), "åªç¤ºç¯„ sqliteï¼Œè‹¥ç”¨ Postgres è«‹æ”¹ç”¨ sqlalchemy"
    return url.replace("sqlite:///", "")

def init():
    path = _sqlite_path(DB_URL)
    os.makedirs(os.path.dirname(path), exist_ok=True)
    conn = sqlite3.connect(path)
    cur = conn.cursor()
    cur.executescript(
        """
        CREATE TABLE IF NOT EXISTS transactions (
          id TEXT PRIMARY KEY,
          source TEXT NOT NULL,
          order_id TEXT NOT NULL,
          amount INTEGER NOT NULL,
          currency TEXT NOT NULL DEFAULT 'TWD',
          paid_at TEXT NOT NULL,
          meta_json TEXT,
          status TEXT NOT NULL DEFAULT 'paid',
          created_at TEXT DEFAULT CURRENT_TIMESTAMP
        );
        CREATE TABLE IF NOT EXISTS revenue_shares (
          id TEXT PRIMARY KEY,
          rule_version TEXT NOT NULL DEFAULT '35-35-30',
          msft_amount INTEGER NOT NULL,
          ours_amount INTEGER NOT NULL,
          google_amount INTEGER NOT NULL,
          computed_at TEXT DEFAULT CURRENT_TIMESTAMP
        );
        """
    )
    conn.commit(); conn.close()

if __name__ == "__main__":
    init(); print("[schema] ok")
```

```python
# jobs/daily_[settlement.py](http://settlement.py)
import os, json, sqlite3, datetime as dt
from decimal import Decimal, ROUND_HALF_UP

REV_MSFT_PCT = Decimal(os.getenv("REV_MSFT_PCT", "35"))
REV_OURS_PCT = Decimal(os.getenv("REV_OURS_PCT", "35"))
REV_GOOG_PCT = Decimal(os.getenv("REV_GOOG_PCT", "30"))
DB_URL = os.getenv("DB_URL", "sqlite:///data/fortress.db")
AMOUNT_UNIT = os.getenv("AMOUNT_UNIT", "TWD")  # TWD or TWD_CENTS

def _sqlite_path(url: str):
    return url.replace("sqlite:///", "")

def _round(n):
    return int(Decimal(n).to_integral_value(rounding=ROUND_HALF_UP))

def _split(amount_int):
    ms = _round(Decimal(amount_int) * REV_MSFT_PCT / 100)
    us = _round(Decimal(amount_int) * REV_OURS_PCT / 100)
    gg = amount_int - ms - us
    return ms, us, gg

def run(date_str=None):
    path = _sqlite_path(DB_URL)
    conn = sqlite3.connect(path)
    cur = conn.cursor()
    if not date_str:
        date_str = [dt.date.today](http://dt.date.today)().isoformat()
    start = f"{date_str}T00:00:00"; end = f"{date_str}T23:59:59"

    rows = list(cur.execute(
        "SELECT id, amount, currency FROM transactions WHERE status='paid' AND paid_at BETWEEN ? AND ?",
        (start, end)))

    for txn_id, amt, ccy in rows:
        ms, us, gg = _split(int(amt))
        cur.execute(
            "REPLACE INTO revenue_shares (id, rule_version, msft_amount, ours_amount, google_amount, computed_at) VALUES (?,?,?,?,?,datetime('now'))",
            (txn_id, '35-35-30', ms, us, gg)
        )
    conn.commit(); conn.close()
    print(f"[settlement] {len(rows)} txns settled for {date_str}")

if __name__ == "__main__":
    run()
```

```python
# jobs/export_[csv.py](http://csv.py)
import os, csv, sqlite3, datetime as dt

DB_URL = os.getenv("DB_URL", "sqlite:///data/fortress.db")
CSV_DELIMITER = os.getenv("CSV_DELIMITER", ",")
OUT_DIR = os.getenv("OUT_DIR", "./out")

def _sqlite_path(url: str):
    return url.replace("sqlite:///", "")

def export(date_str=None):
    if not date_str:
        date_str = [dt.date.today](http://dt.date.today)().isoformat()
    path = _sqlite_path(DB_URL)
    conn = sqlite3.connect(path)
    cur = conn.cursor()
    rows = list(cur.execute(
        "SELECT [t.id](http://t.id), t.amount, t.currency, r.msft_amount, r.ours_amount, [r.google](http://r.google)_amount FROM transactions t JOIN revenue_shares r ON [r.id](http://r.id)=[t.id](http://t.id) WHERE date(t.paid_at)=?",
        (date_str,)))
    os.makedirs(OUT_DIR, exist_ok=True)
    fn = os.path.join(OUT_DIR, f"payout_{date_str.replace('-', '')}_uber.csv")
    with open(fn, "w", newline="", encoding="utf-8") as f:
        w = csv.writer(f, delimiter=CSV_DELIMITER)
        w.writerow(["txn_id","payee","bank_code","bank_account_masked","amount","currency","memo"])
        for txn_id, amount, ccy, ms, us, gg in rows:
            w.writerow([txn_id, "Microsoft", "822", "********2460", ms, ccy, "rev 35%"])
            w.writerow([txn_id, "Ours", "822", "********2460", us, ccy, "rev 35%"])
            w.writerow([txn_id, "Google", "822", "********2460", gg, ccy, "rev 30%"])
    print(f"[export] wrote {fn}")

if __name__ == "__main__":
    export()
```

```makefile
# Makefileï¼ˆæ›´æ–°ï¼‰
.PHONY: run initdb settle export-csv

run:
	python [app.py](http://app.py)

initdb:
	python -m jobs.schema

settle:
	python -m jobs.daily_settlement

export-csv:
	python -m jobs.export_csv
```

```bash
# 1) è¨­å®š .envï¼ˆTelegramã€HMAC ç­‰æ•æ„Ÿå€¼ï¼‰
export TELEGRAM_BOT_TOKEN=...; export TELEGRAM_CHAT_ID=...; export HMAC_SECRET=...
# 2) ä½ˆç½²
docker compose up -d --build
# 3) å¥åº·æª¢æŸ¥
curl http://<HOST>/health
curl "http://<HOST>/transfer?bank_code=822&account=484540302460&amount=10000"
```

### 5) å®‰å…¨åŠ å›ºæª¢æŸ¥è¡¨

- WAFï¼šåªå…è¨± Taiwanï¼Œå°é– United States
- HMACï¼šPOST å¿…é©—ç°½ï¼›æ™‚é–“çª— 300 ç§’ï¼›ä¼ºæœå™¨æ™‚é–“åŒæ­¥ï¼ˆNTPï¼‰
- Secretsï¼šåƒ…ä»¥ç’°å¢ƒè®Šæ•¸æˆ– Secret Managerï¼Œç¦å…¥ repo
- æ—¥èªŒï¼šæ•æ„Ÿå€¼æ‰“ç¢¼ï¼ˆå¸³è™Ÿå¾Œå››ç¢¼ï¼‰ï¼›Mail Dispatch Log èˆ‡ Access Log åŒæ­¥
- æ¬Šé™ï¼šä¸»é«”å¸³æˆ¶ [lightinggithub@gmail.com](mailto:lightinggithub@gmail.com) ç‚ºè¶…ç®¡ï¼›è®Šæ›´éœ€æ†‘ã€Œèªè­‰æ›¸ã€ç°½æ ¸

[å•†æ¥­åˆä½œå°æ¥å°ˆæ¡ˆï¼ˆé–ƒé›»æˆ°ç‰ˆï¼‰](https://www.notion.so/04c8721d9c0146b0868dd5da9d86da5c?pvs=21)

[è‡ªå‹•åŒ–](https://www.notion.so/2c31004cdcad815ab5e1f260141d5fbe?pvs=21)
